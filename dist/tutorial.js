var jsonFormula;(()=>{"use strict";var e=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t={};(()=>{e(t);const r={TYPE_NUMBER:0,TYPE_ANY:1,TYPE_STRING:2,TYPE_ARRAY:3,TYPE_OBJECT:4,TYPE_BOOLEAN:5,TYPE_EXPREF:6,TYPE_NULL:7,TYPE_ARRAY_NUMBER:8,TYPE_ARRAY_STRING:9,TYPE_CLASS:10,TYPE_ARRAY_ARRAY:11,TYPE_EMPTY_ARRAY:12},n={[r.TYPE_NUMBER]:"number",[r.TYPE_ANY]:"any",[r.TYPE_STRING]:"string",[r.TYPE_ARRAY]:"array",[r.TYPE_OBJECT]:"object",[r.TYPE_BOOLEAN]:"boolean",[r.TYPE_EXPREF]:"expression",[r.TYPE_NULL]:"null",[r.TYPE_ARRAY_NUMBER]:"Array<number>",[r.TYPE_ARRAY_STRING]:"Array<string>",[r.TYPE_CLASS]:"class",[r.TYPE_ARRAY_ARRAY]:"Array<array>",[r.TYPE_EMPTY_ARRAY]:"array"},s={TOK_EOF:"EOF",TOK_IDENTIFIER:"Identifier",TOK_QUOTEDIDENTIFIER:"QuotedIdentifier",TOK_RBRACKET:"Rbracket",TOK_RPAREN:"Rparen",TOK_COMMA:"Comma",TOK_COLON:"Colon",TOK_CONCATENATE:"Concatenate",TOK_RBRACE:"Rbrace",TOK_NUMBER:"Number",TOK_CURRENT:"Current",TOK_GLOBAL:"Global",TOK_EXPREF:"Expref",TOK_PIPE:"Pipe",TOK_OR:"Or",TOK_AND:"And",TOK_ADD:"Add",TOK_SUBTRACT:"Subtract",TOK_UNARY_MINUS:"UnaryMinus",TOK_MULTIPLY:"Multiply",TOK_UNION:"Union",TOK_DIVIDE:"Divide",TOK_COMPARATOR:"Comparator",TOK_FLATTEN:"Flatten",TOK_STAR:"Star",TOK_FILTER:"Filter",TOK_DOT:"Dot",TOK_NOT:"Not",TOK_LBRACE:"Lbrace",TOK_LBRACKET:"Lbracket",TOK_LPAREN:"Lparen",TOK_JSON:"Literal",TOK_STRING:"String",TOK_INT:"Integer"};function i(e){return new TypeError(e)}function a(e){const t=new Error(e);return t.name="SyntaxError",t}function o(e){const t=new Error(e);return t.name="FunctionError",t}function u(e){const t=new Error(e);return t.name="EvaluationError",t}function c(e){return Array.isArray(e)}function l(e){return null!==e&&"[object Object]"===Object.prototype.toString.call(e)}function h(e){return null==e?e:c(e)?e.map((e=>h(e))):"function"!=typeof e.valueOf?e:e.valueOf()}function _(e){if(null===e)return!1;const t=h(e);return Array.isArray(t)?t.length>0:l(t)?Object.keys(t).length>0:!!t}function p(e,t){const r=h(e),n=h(t);if(r===n)return!0;if(Object.prototype.toString.call(r)!==Object.prototype.toString.call(n))return!1;if(!0===c(r))return r.length===n.length&&r.every(((e,t)=>p(e,n[t])));if(!0===l(r)){if(Object.keys(r).length!==Object.keys(n).length)return!1;for(const e in r)if(hasOwnProperty.call(r,e)&&!1===p(r[e],n[e]))return!1;return!0}return!1}function d(e,t){const r=Object.getOwnPropertyDescriptor(e,t);if(r?.enumerable||r?.get)return e[t]?.[Symbol.for("track")]?.(e,t),e[t]}function f(e,t,r){try{e.push(`Failed to find: '${r}'`);let n=[];c(t)&&t.length>0&&n.push("0.."+(t.length-1)),null!==t&&(n=[...n,...Object.entries(Object.getOwnPropertyDescriptors(t,r)).filter((([e,t])=>(t?.enumerable||!!t?.get)&&!/^[0-9]+$/.test(e)&&(!e.startsWith("$")||r.startsWith("$")))).map((([e])=>`'${e}'`))]),n.length&&e.push(`Available fields: ${n}`)}catch(e){}}function y(e){return null!==e&&!Array.isArray(e)&&!["Object","Boolean","Number","String"].includes(e.constructor.name)}const{TYPE_NUMBER:g,TYPE_ANY:E,TYPE_STRING:T,TYPE_ARRAY:m,TYPE_OBJECT:v,TYPE_BOOLEAN:R,TYPE_EXPREF:N,TYPE_NULL:O,TYPE_ARRAY_NUMBER:P,TYPE_ARRAY_STRING:A,TYPE_CLASS:Y,TYPE_ARRAY_ARRAY:b,TYPE_EMPTY_ARRAY:S}=r,{TOK_EXPREF:I}=s;function w(e){return[m,P,A,b,S].includes(e)}function x(e,t=!0){if(null===e)return O;let r=e;if(t){if("function"!=typeof e.valueOf)return v;r=e.valueOf()}if(y(r))return Y;switch(Object.prototype.toString.call(r)){case"[object String]":return T;case"[object Number]":return g;case"[object Array]":return 0===r.length?S:r.every((e=>w(x(e))))?b:r.every((e=>x(e)===g))?P:r.every((e=>x(e)===T))?A:m;case"[object Boolean]":return R;case"[object Null]":return O;default:return r.jmespathType===I?N:v}}function M(e){return[m,P,A,b,S].includes(x(e))}function B(e){return n[x(e)]}function U(e,t,r,s,a){const o=x(t);if(t?.jmespathType===I&&!e.includes(N))throw i(`${r} does not accept an expression reference argument.`);const u=e=>e===v;if(e.some((e=>{return(t=e)===(r=o)||t===E||t===m&&w(r)||w(t)&&r===S;var t,r})))return t;const c=e.length>1,l=e[0];let h=!1;if(w(o)&&[P,A].includes(l)&&t.some((e=>{const t=x(e);return w(t)||u(t)}))&&(h=!0),c&&[Y,v].includes(l)&&(h=!0),c)throw i(`${r} cannot process type: ${n[o]}. Must be one of: ${e.map((e=>n[e])).join(", ")}.`);if(h)throw i(`${r} expected argument to be type ${n[l]} but received type ${n[o]} instead.`);if(u(o)&&l===R)return 0===Object.keys(t).length;if(w(o)){const e=e=>Array.isArray(e)?e:[e];if(l===R)return t.length>0;if(l===A)return t.map(a);if(l===P)return t.map(s);if(l===b)return t.map(e)}if(!w(o)&&!u(o)){if(l===A)return o===O?[]:[a(t)];if(l===P)return o===O?[]:[s(t)];if(l===m)return o===O?[]:[t];if([b,S].includes(l)&&o===O)return[];if(l===g)return s(t);if(l===T)return a(t);if(l===R)return!!t;if(l===v&&o===O)return{}}throw i(`${r} expected argument to be type ${n[l]} but received type ${n[o]} instead.`)}const{TOK_CURRENT:K,TOK_GLOBAL:$,TOK_EXPREF:j,TOK_PIPE:k,TOK_FLATTEN:L}=s,{TYPE_STRING:C,TYPE_ARRAY_STRING:F,TYPE_ARRAY:D,TYPE_NUMBER:G}=r;function q(e,t){if(c(e)&&c(t)){const r=e.length<t.length?e:t,n=Math.abs(e.length-t.length);r.length+=n,r.fill(null,r.length-n)}}class J{constructor(e,t,r,n,s,i){this.runtime=e,this.globals=t,this.toNumber=r,this.toString=n,this.debug=s,this.language=i}search(e,t){return this.visit(e,t)}field(e,t){if(null!==t&&(l(t)||c(t))){const r=d(t,e.name);return void 0===r?(f(this.debug,t,e.name),null):r}return f(this.debug,t,e.name),null}visit(e,t){const r={Identifier:this.field.bind(this),QuotedIdentifier:this.field.bind(this),ChainedExpression:(e,t)=>{let r=this.visit(e.children[0],t);for(let t=1;t<e.children.length;t+=1)if(r=this.visit(e.children[1],r),null===r)return null;return r},BracketExpression:(e,t)=>{const r=this.visit(e.children[0],t);return this.visit(e.children[1],r)},Index:(e,t)=>{if(c(t)){let r=e.value.value;r<0&&(r=t.length+r);const n=t[r];return void 0===n?(this.debug.push(`Index: ${r} out of range for array size: ${t.length}`),null):n}return this.debug.push("Left side of index expression must be an array"),this.debug.push(`Did you intend a single-element array? if so, use a JSON literal: \`[${e.value.value}]\``),null},Slice:(e,t)=>{if(!c(t))return this.debug.push("Slices apply to arrays only"),null;const r=e.children.map((e=>null===e?null:e.value)),[n,s,i]=this.computeSliceParams(t.length,r),a=[];if(i>0)for(let e=n;e<s;e+=i)a.push(t[e]);else for(let e=n;e>s;e+=i)a.push(t[e]);return a},Projection:(e,t)=>{const r=this.visit(e.children[0],t);if(!c(r))return"Wildcard"===e.debug&&this.debug.push("Bracketed wildcards apply to arrays only"),null;const n=[];return r.forEach((t=>{const r=this.visit(e.children[1],t);n.push(r)})),n},ValueProjection:(e,t)=>{const r=this.visit(e.children[0],t);if(!l(h(r)))return this.debug.push("Chained wildcards apply to objects only"),null;const n=[];var s;return(s=r,Object.values(s)).forEach((t=>{const r=this.visit(e.children[1],t);n.push(r)})),n},FilterProjection:(e,t)=>{const r=this.visit(e.children[0],t);if(!c(r))return this.debug.push("Filter expressions apply to arrays only"),null;const n=r.filter((t=>_(this.visit(e.children[2],t)))),s=[];return n.forEach((t=>{const r=this.visit(e.children[1],t);s.push(r)})),s},Comparator:(e,t)=>{let r=h(this.visit(e.children[0],t)),n=h(this.visit(e.children[1],t));if("=="===e.value)return p(r,n);if("!="===e.value)return!p(r,n);if(l(r)||c(r))return this.debug.push(`Cannot use comparators with ${B(r)}`),!1;if(l(n)||c(n))return this.debug.push(`Cannot use comparators with ${B(n)}`),!1;const s=x(r),i=x(n);if(s===G||i===G)try{if(r=this.toNumber(r),n=this.toNumber(n),null===r||null===n)return!1}catch(e){return!1}return">"===e.value?r>n:">="===e.value?r>=n:"<"===e.value?r<n:r<=n},[L]:(e,t)=>{const r=this.visit(e.children[0],t);if(!c(r))return this.debug.push("Flatten expressions apply to arrays only. If you want an empty array, use a JSON literal: `[]`"),null;const n=[];return r.forEach((e=>{c(e)?n.push(...e):n.push(e)})),n},Identity:(e,t)=>t,ArrayExpression:(e,t)=>e.children.map((e=>this.visit(e,t))),ObjectExpression:(e,t)=>{const r={};return e.children.forEach((e=>{void 0!==r[e.name]&&this.debug.push(`Duplicate key: '${e.name}'`),r[e.name]=this.visit(e.value,t)})),r},OrExpression:(e,t)=>{let r=this.visit(e.children[0],t);return _(r)||(r=this.visit(e.children[1],t)),r},AndExpression:(e,t)=>{const r=this.visit(e.children[0],t);return _(r)?this.visit(e.children[1],t):r},AddExpression:(e,t)=>{const r=this.visit(e.children[0],t),n=this.visit(e.children[1],t);return q(r,n),this.applyOperator(r,n,"+")},ConcatenateExpression:(e,t)=>{let r=this.visit(e.children[0],t),n=this.visit(e.children[1],t);return q(r,n),r=M(r)?U([F],r,"concatenate",this.toNumber,this.toString):U([C],r,"concatenate",this.toNumber,this.toString),n=M(n)?U([F],n,"concatenate",this.toNumber,this.toString):U([C],n,"concatenate",this.toNumber,this.toString),this.applyOperator(r,n,"&")},UnionExpression:(e,t)=>{let r=this.visit(e.children[0],t),n=this.visit(e.children[1],t);return r=U([D],r,"union",this.toNumber,this.toString),n=U([D],n,"union",this.toNumber,this.toString),r.concat(n)},SubtractExpression:(e,t)=>{const r=this.visit(e.children[0],t),n=this.visit(e.children[1],t);return q(r,n),this.applyOperator(r,n,"-")},MultiplyExpression:(e,t)=>{const r=this.visit(e.children[0],t),n=this.visit(e.children[1],t);return q(r,n),this.applyOperator(r,n,"*")},DivideExpression:(e,t)=>{const r=this.visit(e.children[0],t),n=this.visit(e.children[1],t);return q(r,n),this.applyOperator(r,n,"/")},NotExpression:(e,t)=>!_(this.visit(e.children[0],t)),UnaryMinusExpression:(e,t)=>{const r=this.visit(e.children[0],t),n=-1*r;if(Number.isNaN(n))throw i(`Failed to convert "${r}" to number`);return n},String:e=>e.value,Literal:e=>e.value,Number:e=>e.value,Integer:e=>e.value,[k]:(e,t)=>{const r=this.visit(e.children[0],t);return this.visit(e.children[1],r)},[K]:(e,t)=>t,[$]:e=>{const t=this.globals[e.name];return void 0===t?null:t},Function:(e,t)=>{if("if"===e.name)return this.runtime.callFunction(e.name,e.children,t,this,!1);const r=e.children.map((e=>this.visit(e,t)));return this.runtime.callFunction(e.name,r,t,this)},ExpressionReference:e=>{const[t]=e.children;return t.jmespathType=j,t}};return(e&&r[e.type])(e,t)}computeSliceParams(e,t){function r(e,t,r){let n=t;return n<0?(n+=e,n<0&&(n=r<0?-1:0)):n>=e&&(n=r<0?e-1:e),n}let[n,s,i]=t;if(null===i)i=1;else if(0===i)throw u("Invalid slice, step cannot be 0");const a=i<0;return n=null===n?a?e-1:0:r(e,n,i),s=null===s?a?-1:e:r(e,s,i),[n,s,i]}applyOperator(e,t,r){if(c(e)&&c(t)){const n=[];for(let s=0;s<e.length;s+=1)n.push(this.applyOperator(e[s],t[s],r));return n}if(c(e))return e.map((e=>this.applyOperator(e,t,r)));if(c(t))return t.map((t=>this.applyOperator(e,t,r)));if("&"===r)return e+t;if("*"===r)return this.toNumber(e)*this.toNumber(t);const n=this.toNumber(e),s=this.toNumber(t);if("+"===r)return n+s;if("-"===r)return n-s;const i=n/s;if(!Number.isFinite(i))throw u(`Division by zero ${e}/${t}`);return i}}const{TOK_IDENTIFIER:H,TOK_QUOTEDIDENTIFIER:z,TOK_RBRACKET:X,TOK_RPAREN:Q,TOK_COMMA:V,TOK_COLON:W,TOK_CONCATENATE:Z,TOK_RBRACE:ee,TOK_NUMBER:te,TOK_CURRENT:re,TOK_GLOBAL:ne,TOK_EXPREF:se,TOK_PIPE:ie,TOK_OR:ae,TOK_COMPARATOR:oe,TOK_AND:ue,TOK_ADD:ce,TOK_SUBTRACT:le,TOK_UNARY_MINUS:he,TOK_DIVIDE:_e,TOK_UNION:pe,TOK_FLATTEN:de,TOK_STAR:fe,TOK_FILTER:ye,TOK_DOT:ge,TOK_NOT:Ee,TOK_LBRACE:Te,TOK_LBRACKET:me,TOK_LPAREN:ve,TOK_JSON:Re,TOK_STRING:Ne,TOK_INT:Oe}=s,Pe={".":ge,",":V,":":W,"{":Te,"}":ee,"]":X,"(":ve,")":Q,"@":re},Ae={"<":!0,">":!0,"=":!0,"!":!0},Ye={" ":!0,"\t":!0,"\n":!0};function be(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||e>="0"&&e<="9"||"_"===e}function Se(e,t){const r=e[t];return"$"===r||r>="a"&&r<="z"||r>="A"&&r<="Z"||"_"===r}class Ie{constructor(e=[],t=[]){this._allowedGlobalNames=e,this.debug=t}tokenize(e){const t=[];let r,n,s;for(this._current=0;this._current<e.length;){const i=t.length?t.slice(-1)[0].type:null;if(this._isGlobal(i,e,this._current))t.push(this._consumeGlobal(e));else if(Se(e,this._current))r=this._current,n=this._consumeUnquotedIdentifier(e),t.push({type:H,value:n,start:r});else if(this._isNumber(e))s=this._consumeNumber(e),t.push(s);else if(void 0!==Pe[e[this._current]])t.push({type:Pe[e[this._current]],value:e[this._current],start:this._current}),this._current+=1;else if("-"!==e[this._current]||[ne,re,te,Oe,Q,H,z,X,Re,Ne].includes(i))if("["===e[this._current])s=this._consumeLBracket(e),t.push(s);else if("'"===e[this._current])r=this._current,n=this._consumeQuotedIdentifier(e),t.push({type:z,value:n,start:r});else if('"'===e[this._current])r=this._current,n=this._consumeRawStringLiteral(e),t.push({type:Ne,value:n,start:r});else if("`"===e[this._current]){r=this._current;const n=this._consumeJson(e);t.push({type:Re,value:n,start:r})}else if(void 0!==Ae[e[this._current]])t.push(this._consumeOperator(e));else if(void 0!==Ye[e[this._current]])this._current+=1;else if("&"===e[this._current])r=this._current,this._current+=1,"&"===e[this._current]?(this._current+=1,t.push({type:ue,value:"&&",start:r})):i===V||i===ve?t.push({type:se,value:"&",start:r}):t.push({type:Z,value:"&",start:r});else if("~"===e[this._current])r=this._current,this._current+=1,t.push({type:pe,value:"~",start:r});else if("+"===e[this._current])r=this._current,this._current+=1,t.push({type:ce,value:"+",start:r});else if("-"===e[this._current])r=this._current,this._current+=1,t.push({type:le,value:"-",start:r});else if("*"===e[this._current])r=this._current,this._current+=1,t.push({type:fe,value:"*",start:r});else if("/"===e[this._current])r=this._current,this._current+=1,t.push({type:_e,value:"/",start:r});else{if("|"!==e[this._current])throw a(`Unknown character:${e[this._current]}`);r=this._current,this._current+=1,"|"===e[this._current]?(this._current+=1,t.push({type:ae,value:"||",start:r})):t.push({type:ie,value:"|",start:r})}else s=this._consumeUnaryMinus(e),t.push(s)}return t}_consumeUnquotedIdentifier(e){const t=this._current;for(this._current+=1;this._current<e.length&&("$"===e[this._current]||be(e[this._current]));)this._current+=1;return e.slice(t,this._current)}_consumeQuotedIdentifier(e){const t=this._current;this._current+=1;const r=e.length;let n=!Se(e,t+1);for(;"'"!==e[this._current]&&this._current<r;){let t=this._current;be(e[t])||(n=!0),"\\"!==e[t]||"\\"!==e[t+1]&&"'"!==e[t+1]?t+=1:t+=2,this._current=t}this._current+=1;const s=e.slice(t,this._current);try{n||(this.debug.push(`Suspicious quotes: ${s}`),this.debug.push(`Did you intend a literal? "${s.replace(/'/g,"")}"?`))}catch(e){}return JSON.parse(`"${s.substring(1,s.length-1).replace(/\\'/g,"'")}"`)}_consumeRawStringLiteral(e){const t=this._current;this._current+=1;const r=e.length;for(;'"'!==e[this._current]&&this._current<r;){let t=this._current;"\\"!==e[t]||"\\"!==e[t+1]&&'"'!==e[t+1]?t+=1:t+=2,this._current=t}this._current+=1;const n=e.slice(t+1,this._current-1);if(this._current>r)throw a(`Unterminated string literal at ${t}, "${n}`);try{return JSON.parse(`"${n}"`)}catch(e){throw a(`Invalid string literal: ${n}`)}}_isNumber(e){let t=e[this._current];return t>="0"&&t<="9"||"."===t&&this._current!==e.length&&(t=e[this._current+1],t>="0"&&t<="9")}_consumeNumber(e){const t=this._current,r=e.slice(t),n=r.match(/^[0-9]*\.?[0-9]+(?:[eE][-+]?[0-9]+)?/);if(!n)throw a(`Invalid number: ${r}`);const s=n[0];let i;return this._current+=s.length,s.includes(".")||s.toLowerCase().includes("e")?(i=parseFloat(s),{type:te,value:i,start:t}):(i=parseInt(s,10),{type:Oe,value:i,start:t})}_consumeUnaryMinus(){const e=this._current;return this._current+=1,{type:he,value:"-",start:e}}_consumeLBracket(e){const t=this._current;return this._current+=1,"?"===e[this._current]?(this._current+=1,{type:ye,value:"[?",start:t}):"]"===e[this._current]?(this._current+=1,{type:de,value:"[]",start:t}):{type:me,value:"[",start:t}}_isGlobal(e,t,r){if(null!==e&&e===ge)return!1;if("$"!==t[r])return!1;let n=r+1;for(;n<t.length&&("$"===t[n]||be(t[n]));)n+=1;const s=t.slice(r,n);return this._allowedGlobalNames.includes(s)}_consumeGlobal(e){const t=this._current;for(this._current+=1;this._current<e.length&&("$"===e[this._current]||be(e[this._current]));)this._current+=1;const r=e.slice(t,this._current);return{type:ne,name:r,start:t}}_consumeOperator(e){const t=this._current,r=e[t];return this._current+=1,"!"===r?"="===e[this._current]?(this._current+=1,{type:oe,value:"!=",start:t}):{type:Ee,value:"!",start:t}:"<"===r?"="===e[this._current]?(this._current+=1,{type:oe,value:"<=",start:t}):">"===e[this._current]?(this._current+=1,{type:oe,value:"!=",start:t}):{type:oe,value:"<",start:t}:">"===r?"="===e[this._current]?(this._current+=1,{type:oe,value:">=",start:t}):{type:oe,value:">",start:t}:("="===e[this._current]&&(this._current+=1),{type:oe,value:"==",start:t})}_consumeJson(e){this._current+=1;const t=this._current,r=e.length;for(;"`"!==e[this._current]&&this._current<r;){let t=this._current;"\\"===e[t]&&"`"===e[t+1]?t+=2:t+=1,this._current=t}let n=e.slice(t,this._current).trimStart();if(n=n.replaceAll("\\`","`"),this._current+=1,this._current>r)throw a(`Unterminated JSON literal at ${t}: \`${n}`);return JSON.parse(n)}}const{TOK_JSON:we,TOK_COLON:xe,TOK_EOF:Me,TOK_IDENTIFIER:Be,TOK_QUOTEDIDENTIFIER:Ue,TOK_RBRACKET:Ke,TOK_RPAREN:$e,TOK_COMMA:je,TOK_CONCATENATE:ke,TOK_RBRACE:Le,TOK_NUMBER:Ce,TOK_CURRENT:Fe,TOK_GLOBAL:De,TOK_EXPREF:Ge,TOK_PIPE:qe,TOK_OR:Je,TOK_AND:He,TOK_ADD:ze,TOK_SUBTRACT:Xe,TOK_UNARY_MINUS:Qe,TOK_MULTIPLY:Ve,TOK_DIVIDE:We,TOK_UNION:Ze,TOK_COMPARATOR:et,TOK_FLATTEN:tt,TOK_STAR:rt,TOK_FILTER:nt,TOK_DOT:st,TOK_NOT:it,TOK_LBRACE:at,TOK_LBRACKET:ot,TOK_LPAREN:ut,TOK_STRING:ct,TOK_INT:lt}=s,ht={[Me]:0,[Be]:0,[Ue]:0,[Ke]:0,[$e]:0,[je]:0,[Le]:0,[Ce]:0,[lt]:0,[Fe]:0,[De]:0,[Ge]:0,[qe]:1,[Je]:2,[He]:3,[et]:4,[ke]:5,[ze]:6,[Xe]:6,[Ze]:6,[Ve]:7,[We]:7,[it]:8,[Qe]:8,[tt]:10,[rt]:20,[nt]:21,[st]:40,[at]:50,[ot]:55,[ut]:60};class _t{constructor(e=[]){this._allowedGlobalNames=e}parse(e,t){this.debug=t,this._loadTokens(e),this.index=0;const r=this.expression(0);if(this._lookahead(0)!==Me){const e=this._lookaheadToken(0);throw a(`Unexpected token type: ${e.type}, value: ${e.value}`)}return r}_loadTokens(e){const t=new Ie(this._allowedGlobalNames,this.debug).tokenize(e);t.push({type:Me,value:"",start:e.length}),this.tokens=t}expression(e){const t=this._lookaheadToken(0);this._advance();let r=this.nud(t),n=this._lookaheadToken(0,r);for(;e<ht[n.type];)this._advance(),r=this.led(n,r),n=this._lookaheadToken(0,r);return r}_lookahead(e){return this.tokens[this.index+e].type}_lookaheadToken(e,t={}){const r=this.tokens[this.index+e];return r.type===rt&&([void 0,ot,st,qe,He,Je,je,it,Ve,ze,Xe,We,ut,ke,Ze,et].includes(t.type)||(r.type=Ve)),r}_advance(){this.index+=1}_lookAheadIndex(){let e=0;return this._lookahead(e)===Qe&&(e+=1),this._lookahead(e)===lt&&(e+=1),this._lookahead(e)===Ke||this._lookahead(e)===xe}_getIndex(){return this.index}_setIndex(e){this.index=e}nud(e){let t,r,n,s,i;switch(e.type){case ct:return{type:"String",value:e.value};case we:return{type:"Literal",value:e.value};case Ce:return{type:"Number",value:e.value};case lt:return{type:"Integer",value:e.value};case Be:return{type:"Identifier",name:e.value};case Ue:return s={type:"QuotedIdentifier",name:e.value},s;case it:return r=this.expression(ht.Not),{type:"NotExpression",children:[r]};case Qe:return r=this.expression(ht.UnaryMinus),{type:"UnaryMinusExpression",children:[r]};case rt:return t={type:"Identity"},r=this._lookahead(0)===Ke?{type:"Identity"}:this._parseProjectionRHS(ht.Star),{type:"ValueProjection",children:[t,r]};case nt:return this.led(e,{type:"Identity"});case at:return this._parseObjectExpression();case tt:return t={type:tt,children:[{type:"Identity"}]},r=this._parseProjectionRHS(ht.Flatten),{type:"Projection",children:[t,r]};case ot:return this._lookAheadIndex()?(r=this._parseIndexExpression(),this._projectIfSlice({type:"Identity"},r)):this._lookahead(0)===rt&&this._lookahead(1)===Ke?(this._advance(),this._advance(),r=this._parseProjectionRHS(ht.Star),{type:"Projection",children:[{type:"Identity"},r],debug:"Wildcard"}):this._parseArrayExpression();case Fe:return{type:Fe};case De:return{type:De,name:e.name};case Ge:return n=this.expression(ht.Expref),{type:"ExpressionReference",children:[n]};case ut:for(i=[];this._lookahead(0)!==$e;)n=this.expression(0),i.push(n);return this._match($e),i[0];default:this._errorToken(e)}}led(e,t){let r,n,s,i,o,u,c,l;switch(e.type){case ke:return n=this.expression(ht.Concatenate),{type:"ConcatenateExpression",children:[t,n]};case st:return u=ht.Dot,this._lookahead(0)!==rt?(n=this._parseDotRHS(u),{type:"ChainedExpression",children:[t,n]}):(this._advance(),n=this._parseProjectionRHS(u),{type:"ValueProjection",children:[t,n]});case qe:return n=this.expression(ht.Pipe),{type:qe,children:[t,n]};case Je:return n=this.expression(ht.Or),{type:"OrExpression",children:[t,n]};case He:return n=this.expression(ht.And),{type:"AndExpression",children:[t,n]};case ze:return n=this.expression(ht.Add),{type:"AddExpression",children:[t,n]};case Xe:return n=this.expression(ht.Subtract),{type:"SubtractExpression",children:[t,n]};case Ve:return n=this.expression(ht.Multiply),{type:"MultiplyExpression",children:[t,n]};case We:return n=this.expression(ht.Divide),{type:"DivideExpression",children:[t,n]};case Ze:return n=this.expression(ht.Union),{type:"UnionExpression",children:[t,n]};case ut:if(t.type!==Be)throw a("Bad function syntax. Parenthesis must be preceded by an unquoted identifier");return s=t.name,i=this._parseFunctionArgs(),o={type:"Function",name:s,children:i},o;case nt:return r=this.expression(0),this._match(Ke),n=this._parseProjectionRHS(ht.Filter),{type:"FilterProjection",children:[t,n,r]};case tt:return c={type:tt,children:[t]},l=this._parseProjectionRHS(ht.Flatten),{type:"Projection",children:[c,l]};case et:return this._parseComparator(t,e);case ot:return this._lookahead(0)===rt&&this._lookahead(1)===Ke?(this._advance(),this._advance(),n=this._parseProjectionRHS(ht.Star),{type:"Projection",children:[t,n],debug:"Wildcard"}):(n=this._parseIndexExpression(),this._projectIfSlice(t,n));default:this._errorToken(e)}}_match(e){const t=this._lookaheadToken(0);if(t.type===e)return this._advance(),t;throw a(`Expected ${e}, got: ${t.type}`)}_errorToken(e){throw a(`Unexpected token (${e.type}): "${e.value||e.name}"`)}_parseFunctionArgs(){let e=!0;const t=[];for(;this._lookahead(0)!==$e;)e||this._match(je),t.push(this.expression(0)),e=!1;return this._match($e),t}_parseSignedInt(){const e=this._lookaheadToken(0);return e.type===Qe?(this._advance(),{type:"SignedInt",value:-this._match(lt).value}):(e.type!==lt&&this._errorToken(e),this._advance(),{type:"SignedInt",value:e.value})}_parseIndexExpression(){const e=this._getIndex();if(this._lookahead(0)===xe)return this._parseSliceExpression();const t=this._parseSignedInt();return this._lookahead(0)===xe?(this._setIndex(e),this._parseSliceExpression()):(this._match(Ke),{type:"Index",value:t})}_projectIfSlice(e,t){const r={type:"BracketExpression",children:[e,t]};return"Slice"===t.type?{type:"Projection",children:[r,this._parseProjectionRHS(ht.Star)]}:r}_parseSliceExpression(){const e=[null,null,null];let t=0,r=this._lookahead(0);for(;r!==Ke&&t<3;){if(r===xe&&t<2)t+=1,this._advance();else{e[t]=this._parseSignedInt();const r=this._lookahead(0);if(r!==xe&&r!==Ke)throw a(`Unexpected token: ${r.value}(${r.type})`)}r=this._lookahead(0)}return this._match(Ke),{type:"Slice",children:e}}_parseComparator(e,t){const r=this.expression(ht[t.type]);return{type:"Comparator",value:t.value,children:[e,r]}}_parseDotRHS(e){const t=this._lookahead(0);if([Be,Ue,rt].indexOf(t)>=0)return this.expression(e);if(t===ot)return this._match(ot),this._parseArrayExpression();if(t===at)return this._match(at),this._parseObjectExpression();throw a('Expecting one of: "*", "[", "{", name or quoted name after a dot')}_parseProjectionRHS(e){let t;const r=this._lookaheadToken(0,{type:rt});if(ht[r.type]<=ht[tt])t={type:"Identity"};else if(r.type===ot)t=this.expression(e);else if(r.type===nt)t=this.expression(e);else{if(r.type!==st)throw a(`Unexpected token: ${r.value}(${r.type})`);this._match(st),t=this._parseDotRHS(e)}return t}_parseArrayExpression(){const e=[];for(;this._lookahead(0)!==Ke;){const t=this.expression(0);if(e.push(t),this._lookahead(0)===je&&(this._match(je),this._lookahead(0)===Ke))throw a("Unexpected token Rbracket")}return this._match(Ke),{type:"ArrayExpression",children:e}}_parseObjectExpression(){const e=[],t=[Be,Ue];let r,n,s,i;if(this._lookahead(0)===Le)throw this.debug.push("To create an empty object, use a JSON literal: `{}`"),a("An empty object expression is not allowed");for(;;){if(r=this._lookaheadToken(0),t.indexOf(r.type)<0)throw a(`Expecting an identifier token, got: ${r.type}`);if(n=r.value,this._advance(),this._match(xe),s=this.expression(0),i={type:"KeyValuePair",name:n,value:s},e.push(i),this._lookahead(0)===je)this._match(je);else if(this._lookahead(0)===Le){this._match(Le);break}}return{type:"ObjectExpression",children:e}}}const pt=864e5;function dt(e){return new Date(Math.round(e*pt))}function ft(e){return e/pt}function yt(e,t){if(Number.isNaN(e)||!Number.isFinite(e))throw u(`Call to "${t}()" resulted in an invalid number`);return e}const{TYPE_CLASS:gt,TYPE_OBJECT:Et}=r;function Tt(e){if(null==e)return"";const t=x(e);if(M(t))throw i("Failed to convert array to string");if(t===Et)throw i("Failed to convert object to string");return e.toString()}const mt=e=>{const t=+e;return Number.isNaN(t)?0:t};class vt{constructor(e,t,s={}){this.strictDeepEqual=p,this.toNumber=t,this.functionTable=function(e,t,s,a,c,l,h,y){const{TYPE_NUMBER:g,TYPE_ANY:E,TYPE_STRING:T,TYPE_ARRAY:m,TYPE_OBJECT:v,TYPE_BOOLEAN:R,TYPE_EXPREF:N,TYPE_NULL:O,TYPE_ARRAY_NUMBER:P,TYPE_ARRAY_STRING:A,TYPE_ARRAY_ARRAY:Y}=r;function b(e){let t=l(e);return a(t)===T&&(t=s(t)),t=Math.trunc(e),Number.isNaN(t)?e:t}function S(e,t){const r=l(e);if(a(r)===T)return e;const n=t?b(t):0;return JSON.stringify(r,null,n)}const I={abs:{_func:e=>Math.abs(e[0]),_signature:[{types:[g]}]},acos:{_func:e=>yt(Math.acos(e[0]),"acos"),_signature:[{types:[g]}]},and:{_func:e=>{let t=_(l(e[0]));return e.slice(1).forEach((e=>{t=t&&_(l(e))})),t},_signature:[{types:[r.TYPE_ANY],variadic:!0}]},asin:{_func:e=>yt(Math.asin(e[0]),"asin"),_signature:[{types:[g]}]},atan2:{_func:e=>Math.atan2(e[0],e[1]),_signature:[{types:[g]},{types:[g]}]},avg:{_func:e=>{let t=0;const r=e[0];if(0===r.length)throw u("avg() requires at least one argument");return r.forEach((e=>{t+=e})),t/r.length},_signature:[{types:[P]}]},casefold:{_func:(e,t,r)=>h(e[0]).toLocaleUpperCase(r.language).toLocaleLowerCase(r.language),_signature:[{types:[r.TYPE_STRING]}]},ceil:{_func:e=>Math.ceil(e[0]),_signature:[{types:[g]}]},codePoint:{_func:e=>{const t=h(e[0]);return 0===t.length?null:t.codePointAt(0)},_signature:[{types:[r.TYPE_STRING]}]},contains:{_func:e=>{const t=l(e[0]),r=l(e[1]);if(c(e[0]))return t.some((e=>p(e,r)));const n=Array.from(t);if(a(r)!==T)throw i("contains() requires a string search value for string subjects");if(""===r)return!0;const s=Array.from(r).length;for(let e=0;e<n.length;e+=1)if(n.slice(e,e+s).join("")===r)return!0;return!1},_signature:[{types:[T,m]},{types:[E]}]},cos:{_func:e=>Math.cos(e[0]),_signature:[{types:[g]}]},datedif:{_func:e=>{const t=h(e[2]).toLowerCase(),r=dt(e[0]),n=dt(e[1]);if(n===r)return 0;if(n<r)throw o("end_date must be >= start_date in datedif()");if("d"===t)return Math.floor(ft(n-r));const s=n.getFullYear()-r.getFullYear();let i=n.getMonth()-r.getMonth();const a=n.getDate()-r.getDate();if("y"===t){let e=s;return i<0&&(e-=1),0===i&&a<0&&(e-=1),e}if("m"===t)return 12*s+i+(a<0?-1:0);if("ym"===t)return a<0&&(i-=1),i<=0&&s>0?12+i:i;if("yd"===t)return a<0&&(i-=1),i<0?n.setFullYear(r.getFullYear()+1):n.setFullYear(r.getFullYear()),Math.floor(ft(n-r));throw o(`Unrecognized unit parameter "${t}" for datedif()`)},_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER]},{types:[r.TYPE_STRING]}]},datetime:{_func:e=>{const t=b(e[0]),r=b(e[1])-1,n=b(e[2]),s=e.length>3?b(e[3]):0,i=e.length>4?b(e[4]):0,a=e.length>5?b(e[5]):0,o=e.length>6?b(e[6]):0;return ft(new Date(t,r,n,s,i,a,o))},_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER],optional:!0},{types:[r.TYPE_NUMBER],optional:!0},{types:[r.TYPE_NUMBER],optional:!0},{types:[r.TYPE_NUMBER],optional:!0}]},day:{_func:e=>dt(e[0]).getDate(),_signature:[{types:[r.TYPE_NUMBER]}]},debug:{_func:t=>{const r=t[0];return t.length>1?a(t[1])===N?y.push(e.interpreter.visit(t[1],r)):y.push(t[1]):y.push(S(t[0])),r},_signature:[{types:[r.TYPE_ANY]},{types:[r.TYPE_ANY,r.TYPE_EXPREF],optional:!0}]},deepScan:{_func:e=>{const[r,n]=e,[s,i]=a(n)===g?[b(n),!0]:[h(n),!1],o=[];return function e(r){null!==r&&(c(r)?(i&&void 0!==r[s]&&o.push(r[s]),r.forEach(e)):t(r)&&Object.entries(r).forEach((([t,r])=>{i||t!==s||o.push(r),e(r)})))}(r),o},_signature:[{types:[r.TYPE_OBJECT,r.TYPE_ARRAY,r.TYPE_NULL]},{types:[r.TYPE_STRING,r.TYPE_NUMBER]}]},endsWith:{_func:e=>{const t=l(e[0]),r=l(e[1]),n=Array.from(t).reverse();return Array.from(r).reverse().every(((e,t)=>e===n[t]))},_signature:[{types:[T]},{types:[T]}]},entries:{_func:e=>{const t=l(e[0]);return Object.entries(t)},_signature:[{types:[r.TYPE_ARRAY,r.TYPE_OBJECT]}]},eomonth:{_func:e=>{const t=dt(e[0]),r=b(e[1]);return ft(new Date(t.getFullYear(),t.getMonth()+r+1,0))},_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER]}]},exp:{_func:e=>Math.exp(e[0]),_signature:[{types:[r.TYPE_NUMBER]}]},false:{_func:()=>!1,_signature:[]},find:{_func:e=>{const t=Array.from(h(e[0])),r=Array.from(h(e[1])),n=e.length>2?b(e[2]):0;if(n<0)throw u("find() start position must be >= 0");if(0===t.length)return n>r.length?null:n;for(let e=n;e<r.length;e+=1)if(r.slice(e,e+t.length).every(((e,r)=>e===t[r])))return e;return null},_signature:[{types:[r.TYPE_STRING]},{types:[r.TYPE_STRING]},{types:[r.TYPE_NUMBER],optional:!0}]},floor:{_func:e=>Math.floor(e[0]),_signature:[{types:[g]}]},fromCodePoint:{_func:e=>{const t=b(e[0]);try{return String.fromCodePoint(t)}catch(e){throw u(`Invalid code point: "${t}"`)}},_signature:[{types:[r.TYPE_NUMBER]}]},fromEntries:{_func:e=>{const t=e[0];if(!t.every((e=>2===e.length&&a(e[0])===T)))throw i("fromEntries() requires an array of key value pairs");return Object.fromEntries(t)},_signature:[{types:[r.TYPE_ARRAY_ARRAY]}]},fround:{_func:e=>Math.fround(e[0]),_signature:[{types:[g]}]},hasProperty:{_func:e=>{let t=e[1];const r=a(t);if(c(e[0])){if(r!==g)throw TypeError("hasProperty(): Array index must be an integer");t=b(t)}else if(r!==T)throw TypeError("hasProperty(): Object key must be a string");return void 0!==d(e[0],t)},_signature:[{types:[r.TYPE_ARRAY,v]},{types:[r.TYPE_STRING,r.TYPE_NUMBER]}]},hour:{_func:e=>dt(e[0]).getHours(),_signature:[{types:[r.TYPE_NUMBER]}]},if:{_func:(e,t,r)=>{const n=e[0],s=e[1],a=e[2];e.forEach((e=>{if("ExpressionReference"===e.type)throw i('"if()" does not accept an expression reference argument.')}));const o=r.visit(n,t);return _(l(o))?r.visit(s,t):r.visit(a,t)},_signature:[{types:[r.TYPE_ANY]},{types:[r.TYPE_ANY]},{types:[r.TYPE_ANY]}]},join:{_func:e=>{const t=e[0],r=e[1];return t.map((e=>S(e))).join(r)},_signature:[{types:[m]},{types:[T]}]},keys:{_func:e=>Object.keys(e[0]),_signature:[{types:[v]}]},left:{_func:e=>{const t=e.length>1?b(e[1]):1;if(t<0)throw u("left() requires a non-negative number of elements");return c(e[0])?e[0].slice(0,t):Array.from(h(e[0])).slice(0,t).join("")},_signature:[{types:[r.TYPE_STRING,r.TYPE_ARRAY]},{types:[r.TYPE_NUMBER],optional:!0}]},length:{_func:e=>{const r=l(e[0]);return t(r)?Object.keys(r).length:c(r)?r.length:Array.from(h(r)).length},_signature:[{types:[T,m,v]}]},log:{_func:e=>yt(Math.log(e[0]),"log"),_signature:[{types:[g]}]},log10:{_func:e=>yt(Math.log10(e[0]),"log10"),_signature:[{types:[g]}]},lower:{_func:e=>h(e[0]).toLowerCase(),_signature:[{types:[r.TYPE_STRING]}]},map:{_func:t=>{const r=t[1];return t[0].map((t=>e.interpreter.visit(r,t)))},_signature:[{types:[m]},{types:[N]}]},max:{_func:e=>{const t=e.reduce(((e,t)=>e.concat(t)),[]);if(0===t.length)throw u("max() requires at least one argument");if(!t.every((e=>a(e)===g))&&!t.every((e=>a(e)===T)))throw i("max() requires all arguments to be of the same type");return t.sort(((e,t)=>e>t?1:-1)).pop()},_signature:[{types:[P,A,g,T],variadic:!0}]},merge:{_func:e=>{const t={};return e.forEach((e=>{null!==e&&Object.entries(e||{}).forEach((([e,r])=>{t[e]=r}))})),t},_signature:[{types:[v,O],variadic:!0}]},mid:{_func:e=>{const t=b(e[1]),r=b(e[2]);if(t<0)throw u("mid() requires a non-negative start position");if(r<0)throw u("mid() requires a non-negative length parameter");return c(e[0])?e[0].slice(t,t+r):Array.from(h(e[0])).slice(t,t+r).join("")},_signature:[{types:[r.TYPE_STRING,r.TYPE_ARRAY]},{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER]}]},millisecond:{_func:e=>dt(e[0]).getMilliseconds(),_signature:[{types:[r.TYPE_NUMBER]}]},min:{_func:e=>{const t=e.reduce(((e,t)=>e.concat(t)),[]);if(0===t.length)throw u("min() requires at least one argument");if(!t.every((e=>a(e)===g))&&!t.every((e=>a(e)===T)))throw i("max() requires all arguments to be of the same type");return t.sort(((e,t)=>e<t?1:-1)).pop()},_signature:[{types:[P,A,g,T],variadic:!0}]},minute:{_func:e=>dt(e[0]).getMinutes(),_signature:[{types:[r.TYPE_NUMBER]}]},mod:{_func:e=>{const t=e[0],r=e[1],n=t%r;if(Number.isNaN(n))throw u(`Bad parameter for mod: '${t} % ${r}'`);return n},_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER]}]},month:{_func:e=>dt(e[0]).getMonth()+1,_signature:[{types:[r.TYPE_NUMBER]}]},not:{_func:e=>!_(l(e[0])),_signature:[{types:[r.TYPE_ANY]}]},notNull:{_func:e=>{const t=e.find((e=>a(e)!==O));return void 0===t?null:t},_signature:[{types:[E],variadic:!0}]},now:{_func:()=>ft(Date.now()),_signature:[]},null:{_func:()=>null,_signature:[]},or:{_func:e=>{let t=_(l(e[0]));return e.slice(1).forEach((e=>{t=t||_(l(e))})),t},_signature:[{types:[r.TYPE_ANY],variadic:!0}]},power:{_func:e=>yt(e[0]**e[1],"power"),_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER]}]},proper:{_func:e=>{const t=e=>`${e.charAt(0).toUpperCase()}${e.slice(1).toLowerCase()}`,r=h(e[0]),n=r.match(/[\s\d\p{P}]+|[^\s\d\p{P}]+/gu);return null!==n?n.map((e=>t(e))).join(""):t(r)},_signature:[{types:[r.TYPE_STRING]}]},random:{_func:()=>Math.random(),_signature:[]},reduce:{_func:t=>{const r=t[1];return t[0].reduce(((t,n,s,i)=>e.interpreter.visit(r,{accumulated:t,current:n,index:s,array:i})),3===t.length?t[2]:null)},_signature:[{types:[m]},{types:[N]},{types:[E],optional:!0}]},register:{_func:t=>{const r=t[0],n=t[1];if(!/^_[_a-zA-Z0-9$]*$/.test(r))throw o(`Invalid function name: "${r}"`);if(I[r]&&I[r]._exprefNode.value!==n.value)throw o(`Cannot override function: "${r}" with a different definition`);return I[r]={_func:t=>e.interpreter.visit(n,...t),_signature:[{types:[E],optional:!0}],_exprefNode:n},{}},_signature:[{types:[T]},{types:[N]}]},replace:{_func:e=>{const t=b(e[1]),r=b(e[2]);if(t<0)throw u("replace() start position must be greater than or equal to 0");if(r<0)throw u("replace() length must be greater than or equal to 0");if(c(e[0])){const n=l(e[0]);let s=l(e[3]);return c(s)||(s=[s]),n.splice(t,r,...s),n}const n=Array.from(h(e[0]));if(c(e[3])||a(e[3])===v)throw i("replace() replacement must not be an array or object");const s=h(e[3]);return n.splice(t,r,s),n.join("")},_signature:[{types:[r.TYPE_STRING,r.TYPE_ARRAY]},{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER]},{types:[r.TYPE_ANY]}]},rept:{_func:e=>{const t=h(e[0]),r=b(e[1]);if(r<0)throw u("rept() count must be greater than or equal to 0");return t.repeat(r)},_signature:[{types:[r.TYPE_STRING]},{types:[r.TYPE_NUMBER]}]},reverse:{_func:e=>{const t=l(e[0]);return a(t)===T?Array.from(t).reverse().join(""):e[0].slice(0).reverse()},_signature:[{types:[T,m]}]},right:{_func:e=>{const t=e.length>1?b(e[1]):1;if(t<0)throw u("right() count must be greater than or equal to 0");return e[0]instanceof Array?0===t?[]:e[0].slice(-1*t):0===t?"":Array.from(h(e[0])).slice(-1*t).join("")},_signature:[{types:[r.TYPE_STRING,r.TYPE_ARRAY]},{types:[r.TYPE_NUMBER],optional:!0}]},round:{_func:e=>function(e,t){const r=10**t;return Math.round(e*r)/r}(e[0],e.length>1?b(e[1]):0),_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER],optional:!0}]},search:{_func:e=>{const t=h(e[0]),r=h(e[1]),n=e.length>2?b(e[2]):0;if(n<0)throw o("search() startPos must be greater than or equal to 0");if(null===t||null===r||0===r.length)return[];const s=Array.from(t).reduce(((e,t)=>e.escape?{escape:!1,result:e.result.concat(t)}:"\\"===t?{escape:!0,result:e.result}:"?"===t?{escape:!1,result:e.result.concat("dot")}:"*"===t?"star"===e.result.slice(-1).pop()?e:{escape:!1,result:e.result.concat("star")}:{escape:!1,result:e.result.concat(t)}),{escape:!1,result:[]}).result,i=(e,t,r)=>{if(0===t.length)return r;if(0===e.length)return null;const n=e[0];let[s,...a]=t;const o="star"===s;if(o){if(1===t.length)return r;[s,...a]=t.slice(1)}return n===s||"dot"===s?i(e.slice(1),a,r.concat(n)):o?i(e.slice(1),t,r.concat(n)):null},a=Array.from(r);for(let e=n;e<a.length;e+=1){const t=i(a.slice(e),s,[]);if(null!==t)return[e,t.join("")]}return[]},_signature:[{types:[r.TYPE_STRING]},{types:[r.TYPE_STRING]},{types:[r.TYPE_NUMBER],optional:!0}]},second:{_func:e=>dt(e[0]).getSeconds(),_signature:[{types:[r.TYPE_NUMBER]}]},sign:{_func:e=>Math.sign(e[0]),_signature:[{types:[g]}]},sin:{_func:e=>Math.sin(e[0]),_signature:[{types:[g]}]},sort:{_func:e=>{const t=e[0].slice();return 0===t.length?[]:a(t[0])===T?t.sort():t.sort(((e,t)=>e<t?-1:e>t?1:0))},_signature:[{types:[A,P]}]},sortBy:{_func:t=>{const r=t[0].slice(0);if(0===r.length)return r;const s=t[1],o=a(e.interpreter.visit(s,r[0]));if(![g,T].includes(o))throw i("Bad data type for sortBy()");const u=[];for(let e=0;e<r.length;e+=1)u.push([e,r[e]]);u.sort(((t,r)=>{const u=e.interpreter.visit(s,t[1]),c=a(u),l=e.interpreter.visit(s,r[1]),h=a(l);if(c!==o)throw i(`sortBy expected ${n[o]}, received ${n[c]}`);if(h!==o)throw i(`sortyBy expected ${n[o]}, received ${n[h]}`);return u>l?1:u<l?-1:t[0]-r[0]}));for(let e=0;e<u.length;e+=1)[,r[e]]=u[e];return r},_signature:[{types:[m]},{types:[N]}]},split:{_func:e=>{const t=h(e[0]),r=h(e[1]);return 0===r.length?Array.from(t):t.split(r)},_signature:[{types:[r.TYPE_STRING]},{types:[r.TYPE_STRING]}]},sqrt:{_func:e=>yt(Math.sqrt(e[0]),"sqrt"),_signature:[{types:[r.TYPE_NUMBER]}]},startsWith:{_func:e=>{const t=Array.from(h(e[0])),r=Array.from(h(e[1]));if(r.length>t.length)return!1;for(let e=0;e<r.length;e+=1)if(r[e]!==t[e])return!1;return!0},_signature:[{types:[T]},{types:[T]}]},stdev:{_func:e=>{const t=e[0];if(t.length<=1)throw u("stdev() must have at least two values");const r=t.reduce(((e,t)=>e+t),0)/t.length,n=t.reduce(((e,t)=>e+t*t),0);return yt(Math.sqrt((n-t.length*r*r)/(t.length-1)),"stdev")},_signature:[{types:[r.TYPE_ARRAY_NUMBER]}]},stdevp:{_func:e=>{const t=e[0];if(0===t.length)throw u("stdevp() must have at least one value");const r=t.reduce(((e,t)=>e+t),0)/t.length,n=t.reduce(((e,t)=>e+t*t),0)/t.length;return yt(Math.sqrt(n-r*r),"stdevp")},_signature:[{types:[r.TYPE_ARRAY_NUMBER]}]},substitute:{_func:e=>{const t=Array.from(h(e[0])),r=Array.from(h(e[1])),n=Array.from(h(e[2]));if(0===r.length)return e[0];let s=!0,i=0;if(e.length>3){if(s=!1,i=b(e[3]),i<0)throw u("substitute() which parameter must be greater than or equal to 0");i+=1}let a=0;const o=[];for(let e=0;e<t.length;){const u=r.every(((r,n)=>t[e+n]===r));u&&(a+=1),u&&(s||a===i)?(o.push(...n),e+=r.length):(o.push(t[e]),e+=1)}return o.join("")},_signature:[{types:[r.TYPE_STRING]},{types:[r.TYPE_STRING]},{types:[r.TYPE_STRING]},{types:[r.TYPE_NUMBER],optional:!0}]},sum:{_func:e=>{let t=0;return e[0].forEach((e=>{t+=1*e})),t},_signature:[{types:[P]}]},tan:{_func:e=>Math.tan(e[0]),_signature:[{types:[g]}]},time:{_func:e=>{const t=b(e[0]),r=e.length>1?b(e[1]):0,n=e.length>2?b(e[2]):0;return ft(new Date(1970,0,1,t,r,n))},_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER],optional:!0},{types:[r.TYPE_NUMBER],optional:!0}]},toArray:{_func:e=>c(e[0])?e[0]:[e[0]],_signature:[{types:[E]}]},toDate:{_func:e=>{const t=h(e[0]).replace(/(\d\d\d\d)(\d\d)(\d\d)/,"$1-$2-$3").replace(/T(\d\d)(\d\d)(\d\d)/,"T$1:$2:$3"),r=t.split(/[\D,zZ]+/);let n;if(r.length<=3&&(r.length<3||""===r.find((e=>""===e))))return y.push(`Failed to convert "${e[0]}" to a date`),null;if(r.length<7){const t=[99999,12,31,23,59,59,999];for(let n=0;n<r.length;n+=1)if(r[n]>t[n])return y.push(`Failed to convert "${e[0]}" to a date`),null;n=new Date(...r.map(((e,t)=>1===t?e-1:1*e)))}else n=new Date(t);return n instanceof Date&&Number.isFinite(n.getTime())?ft(n):(y.push(`Failed to convert "${e[0]}" to a date`),null)},_signature:[{types:[T]}]},today:{_func:()=>{const e=new Date(Date.now());return ft(new Date(e.getFullYear(),e.getMonth(),e.getDate()))},_signature:[]},toNumber:{_func:e=>{const t=l(e[0]),r=e.length>1?b(e[1]):10;if(a(t)===T&&10!==r){let e;if(2===r)e=/^[01.]+$/;else if(8===r)e=/^[0-7.]+$/;else{if(16!==r)throw u(`Invalid base: "${r}" for toNumber()`);e=/^[0-9A-Fa-f.]+$/}if(""===t)return 0;if(!e.test(t))return y.push(`Failed to convert "${t}" base "${r}" to number`),null;const n=t.split(".");let s=0;n.length>1&&(s=parseInt(n[1],r)*r**-n[1].length);const i=parseInt(n[0],r)+s;return n.length>2||Number.isNaN(i)?(y.push(`Failed to convert "${t}" base "${r}" to number`),null):i}try{return s(t)}catch(e){return y.push(`Failed to convert "${t}" to number`),null}},_signature:[{types:[E]},{types:[r.TYPE_NUMBER],optional:!0}]},toString:{_func:e=>S(e[0],e.length>1?e[1]:0),_signature:[{types:[E]},{types:[g],optional:!0}]},trim:{_func:e=>h(e[0]).split(" ").filter((e=>e)).join(" "),_signature:[{types:[r.TYPE_STRING]}]},true:{_func:()=>!0,_signature:[]},trunc:{_func:e=>{const t=e[0],r=e.length>1?b(e[1]):0;return(t>=0?Math.floor:Math.ceil)(t*10**r)/10**r},_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER],optional:!0}]},type:{_func:e=>({[g]:"number",[T]:"string",[m]:"array",[P]:"array",[A]:"array",[Y]:"array",[v]:"object",[R]:"boolean",[N]:"expref",[O]:"null"}[a(e[0])]),_signature:[{types:[E]}]},unique:{_func:e=>{const t=e[0].map((e=>l(e)));return e[0].filter(((e,r)=>t.findIndex((t=>p(t,l(e))))===r))},_signature:[{types:[r.TYPE_ARRAY]}]},upper:{_func:e=>h(e[0]).toUpperCase(),_signature:[{types:[r.TYPE_STRING]}]},value:{_func:e=>{const t=a(e[1]);let r=e[1];const n=c(e[0]);if(n){if(t!==g)throw i("value() requires an integer index for arrays");r=b(r)}else if(t!==T)throw i("value() requires a string index for objects");const s=l(e[0]),o=d(s,r);return void 0===o?(n?y.push(`Index: ${r} out of range for array size: ${s.length}`):f(y,s,r),null):o},_signature:[{types:[r.TYPE_OBJECT,r.TYPE_ARRAY,r.TYPE_NULL]},{types:[r.TYPE_STRING,r.TYPE_NUMBER]}]},values:{_func:e=>Object.values(e[0]),_signature:[{types:[v]}]},weekday:{_func:e=>{const t=e[0],r=e.length>1?b(e[1]):1,n=dt(t).getDay();switch(r){case 1:return n+1;case 2:return(n+6)%7+1;case 3:return(n+6)%7;default:throw o(`Unsupported returnType: "${r}" for weekday()`)}},_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER],optional:!0}]},year:{_func:e=>dt(e[0]).getFullYear(),_signature:[{types:[r.TYPE_NUMBER]}]},zip:{_func:e=>{const t=e.reduce(((e,t)=>Math.min(e,t.length)),e[0].length),r=new Array(t);for(let n=0;n<t;n+=1)r[n]=[],e.forEach((e=>{r[n].push(e[n])}));return r},_signature:[{types:[m],variadic:!0}]}};return I}(this,l,t,x,M,h,Tt,e),Object.entries(s).forEach((([e,t])=>{t._runtime=this,this.functionTable[e]=t}))}_validateArgs(e,t,r,n){if(0===r.length&&t.length>0)throw o(`${e}() does not accept parameters`);if(0===r.length)return;let s;const i=r.filter((e=>!e.optional)).length;if(r[r.length-1].variadic){if(t.length<r.length)throw s=1===r.length?" argument":" arguments",o(`${e}() takes at least ${r.length}${s} but received ${t.length}`)}else if(t.length<i||t.length>r.length)throw s=1===r.length?" argument":" arguments",o(`${e}() takes ${r.length}${s} but received ${t.length}`);if(!n)return;let a;const u=r[r.length-1].variadic?t.length:Math.min(r.length,t.length);for(let n=0;n<u;n+=1)a=n>r.length-1?r[r.length-1].types:r[n].types,c=t[n],a.includes(gt)&&y(c)||(t[n]=U(a,t[n],e,this.toNumber,Tt));var c}callFunction(e,t,r,n,s=!0){if(!Object.prototype.hasOwnProperty.call(this.functionTable,e))throw o(`No such function: ${e}()`);const i=this.functionTable[e];return this._validateArgs(e,t,i._signature,s),i._func.call(this,t,r,n)}}class Rt{constructor(e,t,r){this.debug=e,this.toNumber=function(e){return t=>{const r=h(t);if(null===r)return 0;if(r instanceof Array)throw i("Failed to convert array to number");const n=typeof r;if("number"===n)return r;if("string"===n)return e(r);if("boolean"===n)return r?1:0;throw i("Failed to convert object to number")}}(r||mt),this.runtime=new vt(e,this.toNumber,t)}compile(e,t=[]){return new _t(t).parse(e,this.debug)}search(e,t,r={},n="en-US"){this.runtime.interpreter=new J(this.runtime,r,this.toNumber,Tt,this.debug,n);try{return this.runtime.interpreter.search(e,t)}catch(e){if(this.debug.push(e.message||e.toString()),"Error"===e.name)throw u(e.message||e.toString());throw e}}}const Nt=class{constructor(e={},t=null,r=[]){this.customFunctions={...e},this.stringToNumber=t,this.debug=r,this.formula=new Rt(r,e,t)}search(e,t,r={},n="en-US"){const s=this.compile(e,Object.keys(r));return this.run(s,t,n,r)}run(e,t,r,n){return this.formula.search(e,t,n,r)}compile(e,t=[]){return this.debug.length=0,this.formula.compile(e,t)}};function Ot(e,t,r,n){const s=t?new class{_add(e,t){this[e]=t,n.push(t)}valueOf(){return Object.fromEntries(n.map((e=>[e.$name,e.$value])))}}:new class extends Array{_add(e,t){this[e]=t,n.push(t)}valueOf(){return n}};return Object.defineProperty(s,"$name",{get:()=>e}),Object.defineProperty(s,"$fields",{get:()=>r}),Object.defineProperty(s,"$value",{get:()=>s.valueOf()}),s}function Pt(e,t,r){const n=[];if(r instanceof Array)e._add(t,Ot(t,!1,n,[])),r.forEach(((r,s)=>{const i=Pt(e[t],s,r);n.push(...i)}));else if(null!==r&&"object"==typeof r)e._add(t,Ot(t,!0,n,[])),Object.keys(r).forEach((s=>{const i=Pt(e[t],s,r[s]);n.push(...i)}));else{const s=function(e,t,r=!1,n=!0){const s=new class{valueOf(){return t}toString(){return t.toString()}toJSON(){return t}};return Object.defineProperty(s,"$name",{get:()=>e}),Object.defineProperty(s,"$value",{get:()=>t}),Object.defineProperty(s,"$readonly",{get:()=>r}),Object.defineProperty(s,"$required",{get:()=>n}),s}(t,r);e._add(t,s),n.push(s)}return n}function At(e){const t=+e;if(Number.isNaN(t))throw i(`Failed to convert "${e}" to number`);return t}window.addEventListener("load",(()=>{const e=document.getElementById("data"),t=document.getElementById("expression"),r=document.getElementById("result"),n=document.getElementById("debug"),s=[],i=new Nt({},At,s),a='{\n    "address": {\n      "street": "12 Oak St",\n      "city": "San Jose",\n      "state": "CA",\n      "country": "USA",\n      "phone": "1234561234"\n    },\n    "items": [\n      {\n        "desc": "pens",\n        "quantity": 2,\n        "price": 3.23\n      },\n      {\n        "desc": "pencils",\n        "quantity": 3,\n        "price": 1.34\n      }\n    ],\n    "tax": 1.13\n  }',o=new URLSearchParams(document.location.search);if(o.has("sample")){const r=JSON.parse(atob(o.get("sample")));r.data&&(e.value=JSON.stringify(r.data,null,2)),r.expression&&(t.value=r.expression),r.description&&(document.getElementById("description-row").style.display="table-row",document.getElementById("description").innerText=r.description),Array.from(document.getElementsByClassName("controls")).forEach((e=>e.classList.add("hidden")))}else{const r=window.localStorage.getItem("data");e.value=r||a;const n=window.localStorage.getItem("expression");t.value=n||"sum(items[*].price * items[*].quantity)"}function u(){window.localStorage.setItem("data",e.value),window.localStorage.setItem("expression",t.value);const a=t.value,o=document.getElementById("use-fields").checked;let u;try{u=JSON.parse(e.value),o&&(u=function(e){if(null===e||"object"!=typeof e)return e;const t=[],r=Ot("",!Array.isArray(e),t,[]);return Object.entries(e).forEach((([e,n])=>{t.push(...Pt(r,e,n))})),r}(u))}catch(e){return void(r.value=e.toString())}try{const e=i.search(a,u,{});n.innerHTML=s.join("\n");let t=e;null!=e&&(t=e.valueOf.call(e)),r.value="object"==typeof t?JSON.stringify(t,null,2):t}catch(e){r.value=e.toString(),n.innerHTML=s.join("\n")}}e.addEventListener("blur",u),t.addEventListener("blur",u),document.getElementById("data-reset").addEventListener("click",(()=>{e.value=a,o.has("sample")&&(t.value="sum(items[*].price * items[*].quantity)",document.getElementById("description-row").style.display="none",Array.from(document.getElementsByClassName("controls")).forEach((e=>e.classList.remove("hidden"))),window.history.pushState({},document.title,"/"),u())})),document.getElementById("canned").addEventListener("change",(e=>{t.value=e.target.value,u()})),u(),fetch("../antlr/JsonFormula.g4").then((e=>{e.text().then((e=>{const t=e.replace(/[\s\S.]*grammar/m,"grammar").replace(/#.*/g,"");document.getElementById("grammar-out").innerHTML=t}))}))}))})(),jsonFormula=t})();
//# sourceMappingURL=tutorial.js.map