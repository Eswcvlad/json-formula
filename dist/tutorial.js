var jsonFormula;(()=>{"use strict";var e=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t={};(()=>{e(t);const r={TYPE_NUMBER:0,TYPE_ANY:1,TYPE_STRING:2,TYPE_ARRAY:3,TYPE_OBJECT:4,TYPE_BOOLEAN:5,TYPE_EXPREF:6,TYPE_NULL:7,TYPE_ARRAY_NUMBER:8,TYPE_ARRAY_STRING:9,TYPE_ARRAY_ARRAY:10,TYPE_EMPTY_ARRAY:11},n={[r.TYPE_NUMBER]:"number",[r.TYPE_ANY]:"any",[r.TYPE_STRING]:"string",[r.TYPE_ARRAY]:"array",[r.TYPE_OBJECT]:"object",[r.TYPE_BOOLEAN]:"boolean",[r.TYPE_EXPREF]:"expression",[r.TYPE_NULL]:"null",[r.TYPE_ARRAY_NUMBER]:"Array<number>",[r.TYPE_ARRAY_STRING]:"Array<string>",[r.TYPE_ARRAY_ARRAY]:"Array<array>",[r.TYPE_EMPTY_ARRAY]:"array"},s={TOK_EOF:"EOF",TOK_IDENTIFIER:"Identifier",TOK_QUOTEDIDENTIFIER:"QuotedIdentifier",TOK_RBRACKET:"Rbracket",TOK_RPAREN:"Rparen",TOK_COMMA:"Comma",TOK_COLON:"Colon",TOK_CONCATENATE:"Concatenate",TOK_RBRACE:"Rbrace",TOK_NUMBER:"Number",TOK_CURRENT:"Current",TOK_GLOBAL:"Global",TOK_EXPREF:"Expref",TOK_PIPE:"Pipe",TOK_OR:"Or",TOK_AND:"And",TOK_ADD:"Add",TOK_SUBTRACT:"Subtract",TOK_UNARY_MINUS:"UnaryMinus",TOK_MULTIPLY:"Multiply",TOK_UNION:"Union",TOK_DIVIDE:"Divide",TOK_COMPARATOR:"Comparator",TOK_FLATTEN:"Flatten",TOK_STAR:"Star",TOK_FILTER:"Filter",TOK_DOT:"Dot",TOK_NOT:"Not",TOK_LBRACE:"Lbrace",TOK_LBRACKET:"Lbracket",TOK_LPAREN:"Lparen",TOK_JSON:"Literal",TOK_STRING:"String",TOK_INT:"Integer"};function i(e){return new TypeError(e)}function o(e){const t=new Error(e);return t.name="SyntaxError",t}function a(e){const t=new Error(e);return t.name="FunctionError",t}function u(e){const t=new Error(e);return t.name="EvaluationError",t}const{TYPE_NUMBER:c,TYPE_ANY:l,TYPE_STRING:h,TYPE_ARRAY:_,TYPE_OBJECT:p,TYPE_BOOLEAN:d,TYPE_EXPREF:f,TYPE_NULL:y,TYPE_ARRAY_NUMBER:g,TYPE_ARRAY_STRING:E,TYPE_ARRAY_ARRAY:T,TYPE_EMPTY_ARRAY:m}=r,{TOK_EXPREF:v}=s;function R(e){return[_,g,E,T,m].includes(e)}function N(e){if(null===e)return y;const t=JSON.parse(JSON.stringify(e));switch(Object.prototype.toString.call(t)){case"[object String]":return h;case"[object Number]":return c;case"[object Array]":return 0===t.length?m:t.every((e=>R(N(e))))?T:t.every((e=>N(e)===c))?g:t.every((e=>N(e)===h))?E:_;case"[object Boolean]":return d;case"[object Null]":return y;default:return t.jmespathType===v?f:p}}function O(e){return[_,g,E,T,m].includes(N(e))}function P(e){return n[N(e)]}function b(e,t,r,s,o){const a=N(t);if(t?.jmespathType===v&&!e.includes(f))throw i(`${r} does not accept an expression reference argument.`);const u=e=>e===p;if(e.some((e=>{return(t=e)===(r=a)||t===l||t===_&&R(r)||R(t)&&r===m;var t,r})))return t;const O=e.length>1,P=e[0];let b=!1;if(R(a)&&[g,E].includes(P)&&t.some((e=>{const t=N(e);return R(t)||u(t)}))&&(b=!0),O&&P===p&&(b=!0),O)throw i(`${r} cannot process type: ${n[a]}. Must be one of: ${e.map((e=>n[e])).join(", ")}.`);if(b)throw i(`${r} expected argument to be type ${n[P]} but received type ${n[a]} instead.`);if(u(a)&&P===d)return 0===Object.keys(t).length;if(R(a)){const e=e=>Array.isArray(e)?e:[e];if(P===d)return t.length>0;if(P===E)return t.map(o);if(P===g)return t.map(s);if(P===T)return t.map(e)}if(!R(a)&&!u(a)){if(P===E)return a===y?[]:[o(t)];if(P===g)return a===y?[]:[s(t)];if(P===_)return a===y?[]:[t];if([T,m].includes(P)&&a===y)return[];if(P===c)return s(t);if(P===h)return o(t);if(P===d)return!!t;if(P===p&&a===y)return{}}throw i(`${r} expected argument to be type ${n[P]} but received type ${n[a]} instead.`)}function Y(e){return Array.isArray(e)}function A(e){return null!==e&&"[object Object]"===Object.prototype.toString.call(e)}function S(e){return null==e?e:Y(e)?e.map((e=>S(e))):"function"!=typeof e.valueOf?e:e.valueOf()}function w(e){if(null===e)return!1;const t=S(e);return Array.isArray(t)?t.length>0:A(t)?Object.keys(t).length>0:!!t}function I(e,t){const r=S(e),n=S(t);if(r===n)return!0;if(Object.prototype.toString.call(r)!==Object.prototype.toString.call(n))return!1;if(!0===Y(r))return r.length===n.length&&r.every(((e,t)=>I(e,n[t])));if(!0===A(r)){if(Object.keys(r).length!==Object.keys(n).length)return!1;for(const e in r)if(hasOwnProperty.call(r,e)&&!1===I(r[e],n[e]))return!1;return!0}return!1}function x(e,t){const r=Object.getOwnPropertyDescriptor(e,t);if(r?.enumerable||r?.get)return e[t]?.[Symbol.for("track")]?.(e,t),e[t]}function M(e,t,r){try{e.push(`Failed to find: '${r}'`);let n=[];Y(t)&&t.length>0&&n.push("0.."+(t.length-1)),null!==t&&(n=[...n,...Object.entries(Object.getOwnPropertyDescriptors(t,r)).filter((([e,t])=>(t?.enumerable||!!t?.get)&&!/^[0-9]+$/.test(e)&&(!e.startsWith("$")||r.startsWith("$")))).map((([e])=>`'${e}'`))]),n.length&&e.push(`Available fields: ${n}`)}catch(e){}}const{TOK_CURRENT:B,TOK_GLOBAL:U,TOK_EXPREF:K,TOK_PIPE:j,TOK_FLATTEN:$}=s,{TYPE_STRING:k,TYPE_ARRAY_STRING:F,TYPE_ARRAY:C,TYPE_NUMBER:L}=r;function D(e,t){if(Y(e)&&Y(t)){const r=e.length<t.length?e:t,n=Math.abs(e.length-t.length);r.length+=n,r.fill(null,r.length-n)}}class G{constructor(e,t,r,n,s,i){this.runtime=e,this.globals=t,this.toNumber=r,this.toString=n,this.debug=s,this.language=i}search(e,t){return this.visit(e,t)}field(e,t){if(null!==t&&(A(t)||Y(t))){const r=x(t,e.name);return void 0===r?(M(this.debug,t,e.name),null):r}return M(this.debug,t,e.name),null}visit(e,t){const r={Identifier:this.field.bind(this),QuotedIdentifier:this.field.bind(this),ChainedExpression:(e,t)=>{let r=this.visit(e.children[0],t);for(let t=1;t<e.children.length;t+=1)if(r=this.visit(e.children[1],r),null===r)return null;return r},BracketExpression:(e,t)=>{const r=this.visit(e.children[0],t);return this.visit(e.children[1],r)},Index:(e,t)=>{if(Y(t)){let r=e.value.value;r<0&&(r=t.length+r);const n=t[r];return void 0===n?(this.debug.push(`Index: ${r} out of range for array size: ${t.length}`),null):n}return this.debug.push("Left side of index expression must be an array"),this.debug.push(`Did you intend a single-element array? if so, use a JSON literal: \`[${e.value.value}]\``),null},Slice:(e,t)=>{if(!Y(t))return this.debug.push("Slices apply to arrays only"),null;const r=e.children.map((e=>null===e?null:e.value)),[n,s,i]=this.computeSliceParams(t.length,r),o=[];if(i>0)for(let e=n;e<s;e+=i)o.push(t[e]);else for(let e=n;e>s;e+=i)o.push(t[e]);return o},Projection:(e,t)=>{const r=this.visit(e.children[0],t);if(!Y(r))return"Wildcard"===e.debug&&this.debug.push("Bracketed wildcards apply to arrays only"),null;const n=[];return r.forEach((t=>{const r=this.visit(e.children[1],t);n.push(r)})),n},ValueProjection:(e,t)=>{const r=this.visit(e.children[0],t);if(!A(S(r)))return this.debug.push("Chained wildcards apply to objects only"),null;const n=[];var s;return(s=r,Object.values(s)).forEach((t=>{const r=this.visit(e.children[1],t);n.push(r)})),n},FilterProjection:(e,t)=>{const r=this.visit(e.children[0],t);if(!Y(r))return this.debug.push("Filter expressions apply to arrays only"),null;const n=r.filter((t=>w(this.visit(e.children[2],t)))),s=[];return n.forEach((t=>{const r=this.visit(e.children[1],t);s.push(r)})),s},Comparator:(e,t)=>{let r=S(this.visit(e.children[0],t)),n=S(this.visit(e.children[1],t));if("=="===e.value)return I(r,n);if("!="===e.value)return!I(r,n);if(A(r)||Y(r))return this.debug.push(`Cannot use comparators with ${P(r)}`),!1;if(A(n)||Y(n))return this.debug.push(`Cannot use comparators with ${P(n)}`),!1;const s=N(r),i=N(n);if(s===L||i===L)try{if(r=this.toNumber(r),n=this.toNumber(n),null===r||null===n)return!1}catch(e){return!1}return">"===e.value?r>n:">="===e.value?r>=n:"<"===e.value?r<n:r<=n},[$]:(e,t)=>{const r=this.visit(e.children[0],t);if(!Y(r))return this.debug.push("Flatten expressions apply to arrays only. If you want an empty array, use a JSON literal: `[]`"),null;const n=[];return r.forEach((e=>{Y(e)?n.push(...e):n.push(e)})),n},Identity:(e,t)=>t,ArrayExpression:(e,t)=>e.children.map((e=>this.visit(e,t))),ObjectExpression:(e,t)=>{const r={};return e.children.forEach((e=>{void 0!==r[e.name]&&this.debug.push(`Duplicate key: '${e.name}'`),r[e.name]=this.visit(e.value,t)})),r},OrExpression:(e,t)=>{let r=this.visit(e.children[0],t);return w(r)||(r=this.visit(e.children[1],t)),r},AndExpression:(e,t)=>{const r=this.visit(e.children[0],t);return w(r)?this.visit(e.children[1],t):r},AddExpression:(e,t)=>{const r=this.visit(e.children[0],t),n=this.visit(e.children[1],t);return D(r,n),this.applyOperator(r,n,"+")},ConcatenateExpression:(e,t)=>{let r=this.visit(e.children[0],t),n=this.visit(e.children[1],t);return D(r,n),r=O(r)?b([F],r,"concatenate",this.toNumber,this.toString):b([k],r,"concatenate",this.toNumber,this.toString),n=O(n)?b([F],n,"concatenate",this.toNumber,this.toString):b([k],n,"concatenate",this.toNumber,this.toString),this.applyOperator(r,n,"&")},UnionExpression:(e,t)=>{let r=this.visit(e.children[0],t),n=this.visit(e.children[1],t);return r=b([C],r,"union",this.toNumber,this.toString),n=b([C],n,"union",this.toNumber,this.toString),r.concat(n)},SubtractExpression:(e,t)=>{const r=this.visit(e.children[0],t),n=this.visit(e.children[1],t);return D(r,n),this.applyOperator(r,n,"-")},MultiplyExpression:(e,t)=>{const r=this.visit(e.children[0],t),n=this.visit(e.children[1],t);return D(r,n),this.applyOperator(r,n,"*")},DivideExpression:(e,t)=>{const r=this.visit(e.children[0],t),n=this.visit(e.children[1],t);return D(r,n),this.applyOperator(r,n,"/")},NotExpression:(e,t)=>!w(this.visit(e.children[0],t)),UnaryMinusExpression:(e,t)=>{const r=this.visit(e.children[0],t),n=-1*r;if(Number.isNaN(n))throw i(`Failed to convert "${r}" to number`);return n},String:e=>e.value,Literal:e=>e.value,Number:e=>e.value,Integer:e=>e.value,[j]:(e,t)=>{const r=this.visit(e.children[0],t);return this.visit(e.children[1],r)},[B]:(e,t)=>t,[U]:e=>{const t=this.globals[e.name];return void 0===t?null:t},Function:(e,t)=>{if("if"===e.name)return this.runtime.callFunction(e.name,e.children,t,this,!1);const r=e.children.map((e=>this.visit(e,t)));return this.runtime.callFunction(e.name,r,t,this)},ExpressionReference:e=>{const[t]=e.children;return t.jmespathType=K,t}};return(e&&r[e.type])(e,t)}computeSliceParams(e,t){function r(e,t,r){let n=t;return n<0?(n+=e,n<0&&(n=r<0?-1:0)):n>=e&&(n=r<0?e-1:e),n}let[n,s,i]=t;if(null===i)i=1;else if(0===i)throw u("Invalid slice, step cannot be 0");const o=i<0;return n=null===n?o?e-1:0:r(e,n,i),s=null===s?o?-1:e:r(e,s,i),[n,s,i]}applyOperator(e,t,r){if(Y(e)&&Y(t)){const n=[];for(let s=0;s<e.length;s+=1)n.push(this.applyOperator(e[s],t[s],r));return n}if(Y(e))return e.map((e=>this.applyOperator(e,t,r)));if(Y(t))return t.map((t=>this.applyOperator(e,t,r)));if("&"===r)return e+t;if("*"===r)return this.toNumber(e)*this.toNumber(t);const n=this.toNumber(e),s=this.toNumber(t);if("+"===r)return n+s;if("-"===r)return n-s;const i=n/s;if(!Number.isFinite(i))throw u(`Division by zero ${e}/${t}`);return i}}const{TOK_IDENTIFIER:q,TOK_QUOTEDIDENTIFIER:J,TOK_RBRACKET:H,TOK_RPAREN:z,TOK_COMMA:X,TOK_COLON:Q,TOK_CONCATENATE:V,TOK_RBRACE:W,TOK_NUMBER:Z,TOK_CURRENT:ee,TOK_GLOBAL:te,TOK_EXPREF:re,TOK_PIPE:ne,TOK_OR:se,TOK_COMPARATOR:ie,TOK_AND:oe,TOK_ADD:ae,TOK_SUBTRACT:ue,TOK_UNARY_MINUS:ce,TOK_DIVIDE:le,TOK_UNION:he,TOK_FLATTEN:_e,TOK_STAR:pe,TOK_FILTER:de,TOK_DOT:fe,TOK_NOT:ye,TOK_LBRACE:ge,TOK_LBRACKET:Ee,TOK_LPAREN:Te,TOK_JSON:me,TOK_STRING:ve,TOK_INT:Re}=s,Ne={".":fe,",":X,":":Q,"{":ge,"}":W,"]":H,"(":Te,")":z,"@":ee},Oe={"<":!0,">":!0,"=":!0,"!":!0},Pe={" ":!0,"\t":!0,"\n":!0};function be(e){return e>="a"&&e<="z"||e>="A"&&e<="Z"||e>="0"&&e<="9"||"_"===e}function Ye(e,t){const r=e[t];return"$"===r||r>="a"&&r<="z"||r>="A"&&r<="Z"||"_"===r}class Ae{constructor(e=[],t=[]){this._allowedGlobalNames=e,this.debug=t}tokenize(e){const t=[];let r,n,s;for(this._current=0;this._current<e.length;){const i=t.length?t.slice(-1)[0].type:null;if(this._isGlobal(i,e,this._current))t.push(this._consumeGlobal(e));else if(Ye(e,this._current))r=this._current,n=this._consumeUnquotedIdentifier(e),t.push({type:q,value:n,start:r});else if(this._isNumber(e))s=this._consumeNumber(e),t.push(s);else if(void 0!==Ne[e[this._current]])t.push({type:Ne[e[this._current]],value:e[this._current],start:this._current}),this._current+=1;else if("-"!==e[this._current]||[te,ee,Z,Re,z,q,J,H,me,ve].includes(i))if("["===e[this._current])s=this._consumeLBracket(e),t.push(s);else if("'"===e[this._current])r=this._current,n=this._consumeQuotedIdentifier(e),t.push({type:J,value:n,start:r});else if('"'===e[this._current])r=this._current,n=this._consumeRawStringLiteral(e),t.push({type:ve,value:n,start:r});else if("`"===e[this._current]){r=this._current;const n=this._consumeJson(e);t.push({type:me,value:n,start:r})}else if(void 0!==Oe[e[this._current]])t.push(this._consumeOperator(e));else if(void 0!==Pe[e[this._current]])this._current+=1;else if("&"===e[this._current])r=this._current,this._current+=1,"&"===e[this._current]?(this._current+=1,t.push({type:oe,value:"&&",start:r})):i===X||i===Te?t.push({type:re,value:"&",start:r}):t.push({type:V,value:"&",start:r});else if("~"===e[this._current])r=this._current,this._current+=1,t.push({type:he,value:"~",start:r});else if("+"===e[this._current])r=this._current,this._current+=1,t.push({type:ae,value:"+",start:r});else if("-"===e[this._current])r=this._current,this._current+=1,t.push({type:ue,value:"-",start:r});else if("*"===e[this._current])r=this._current,this._current+=1,t.push({type:pe,value:"*",start:r});else if("/"===e[this._current])r=this._current,this._current+=1,t.push({type:le,value:"/",start:r});else{if("|"!==e[this._current])throw o(`Unknown character:${e[this._current]}`);r=this._current,this._current+=1,"|"===e[this._current]?(this._current+=1,t.push({type:se,value:"||",start:r})):t.push({type:ne,value:"|",start:r})}else s=this._consumeUnaryMinus(e),t.push(s)}return t}_consumeUnquotedIdentifier(e){const t=this._current;for(this._current+=1;this._current<e.length&&("$"===e[this._current]||be(e[this._current]));)this._current+=1;return e.slice(t,this._current)}_consumeQuotedIdentifier(e){const t=this._current;this._current+=1;const r=e.length;let n=!Ye(e,t+1);for(;"'"!==e[this._current]&&this._current<r;){let t=this._current;be(e[t])||(n=!0),"\\"!==e[t]||"\\"!==e[t+1]&&"'"!==e[t+1]?t+=1:t+=2,this._current=t}this._current+=1;const s=e.slice(t,this._current);try{n||(this.debug.push(`Suspicious quotes: ${s}`),this.debug.push(`Did you intend a literal? "${s.replace(/'/g,"")}"?`))}catch(e){}return JSON.parse(`"${s.substring(1,s.length-1).replace(/\\'/g,"'")}"`)}_consumeRawStringLiteral(e){const t=this._current;this._current+=1;const r=e.length;for(;'"'!==e[this._current]&&this._current<r;){let t=this._current;"\\"!==e[t]||"\\"!==e[t+1]&&'"'!==e[t+1]?t+=1:t+=2,this._current=t}this._current+=1;const n=e.slice(t+1,this._current-1);if(this._current>r)throw o(`Unterminated string literal at ${t}, "${n}`);try{return JSON.parse(`"${n}"`)}catch(e){throw o(`Invalid string literal: ${n}`)}}_isNumber(e){let t=e[this._current];return t>="0"&&t<="9"||"."===t&&this._current!==e.length&&(t=e[this._current+1],t>="0"&&t<="9")}_consumeNumber(e){const t=this._current,r=e.slice(t),n=r.match(/^[0-9]*\.?[0-9]+(?:[eE][-+]?[0-9]+)?/);if(!n)throw o(`Invalid number: ${r}`);const s=n[0];let i;return this._current+=s.length,s.includes(".")||s.toLowerCase().includes("e")?(i=parseFloat(s),{type:Z,value:i,start:t}):(i=parseInt(s,10),{type:Re,value:i,start:t})}_consumeUnaryMinus(){const e=this._current;return this._current+=1,{type:ce,value:"-",start:e}}_consumeLBracket(e){const t=this._current;return this._current+=1,"?"===e[this._current]?(this._current+=1,{type:de,value:"[?",start:t}):"]"===e[this._current]?(this._current+=1,{type:_e,value:"[]",start:t}):{type:Ee,value:"[",start:t}}_isGlobal(e,t,r){if(null!==e&&e===fe)return!1;if("$"!==t[r])return!1;let n=r+1;for(;n<t.length&&("$"===t[n]||be(t[n]));)n+=1;const s=t.slice(r,n);return this._allowedGlobalNames.includes(s)}_consumeGlobal(e){const t=this._current;for(this._current+=1;this._current<e.length&&("$"===e[this._current]||be(e[this._current]));)this._current+=1;const r=e.slice(t,this._current);return{type:te,name:r,start:t}}_consumeOperator(e){const t=this._current,r=e[t];return this._current+=1,"!"===r?"="===e[this._current]?(this._current+=1,{type:ie,value:"!=",start:t}):{type:ye,value:"!",start:t}:"<"===r?"="===e[this._current]?(this._current+=1,{type:ie,value:"<=",start:t}):">"===e[this._current]?(this._current+=1,{type:ie,value:"!=",start:t}):{type:ie,value:"<",start:t}:">"===r?"="===e[this._current]?(this._current+=1,{type:ie,value:">=",start:t}):{type:ie,value:">",start:t}:("="===e[this._current]&&(this._current+=1),{type:ie,value:"==",start:t})}_consumeJson(e){this._current+=1;const t=this._current,r=e.length;for(;"`"!==e[this._current]&&this._current<r;){let t=this._current;"\\"===e[t]&&"`"===e[t+1]?t+=2:t+=1,this._current=t}let n=e.slice(t,this._current).trimStart();if(n=n.replaceAll("\\`","`"),this._current+=1,this._current>r)throw o(`Unterminated JSON literal at ${t}: \`${n}`);return JSON.parse(n)}}const{TOK_JSON:Se,TOK_COLON:we,TOK_EOF:Ie,TOK_IDENTIFIER:xe,TOK_QUOTEDIDENTIFIER:Me,TOK_RBRACKET:Be,TOK_RPAREN:Ue,TOK_COMMA:Ke,TOK_CONCATENATE:je,TOK_RBRACE:$e,TOK_NUMBER:ke,TOK_CURRENT:Fe,TOK_GLOBAL:Ce,TOK_EXPREF:Le,TOK_PIPE:De,TOK_OR:Ge,TOK_AND:qe,TOK_ADD:Je,TOK_SUBTRACT:He,TOK_UNARY_MINUS:ze,TOK_MULTIPLY:Xe,TOK_DIVIDE:Qe,TOK_UNION:Ve,TOK_COMPARATOR:We,TOK_FLATTEN:Ze,TOK_STAR:et,TOK_FILTER:tt,TOK_DOT:rt,TOK_NOT:nt,TOK_LBRACE:st,TOK_LBRACKET:it,TOK_LPAREN:ot,TOK_STRING:at,TOK_INT:ut}=s,ct={[Ie]:0,[xe]:0,[Me]:0,[Be]:0,[Ue]:0,[Ke]:0,[$e]:0,[ke]:0,[ut]:0,[Fe]:0,[Ce]:0,[Le]:0,[De]:1,[Ge]:2,[qe]:3,[We]:4,[je]:5,[Je]:6,[He]:6,[Ve]:6,[Xe]:7,[Qe]:7,[nt]:8,[ze]:8,[Ze]:10,[et]:20,[tt]:21,[rt]:40,[st]:50,[it]:55,[ot]:60};class lt{constructor(e=[]){this._allowedGlobalNames=e}parse(e,t){this.debug=t,this._loadTokens(e),this.index=0;const r=this.expression(0);if(this._lookahead(0)!==Ie){const e=this._lookaheadToken(0);throw o(`Unexpected token type: ${e.type}, value: ${e.value}`)}return r}_loadTokens(e){const t=new Ae(this._allowedGlobalNames,this.debug).tokenize(e);t.push({type:Ie,value:"",start:e.length}),this.tokens=t}expression(e){const t=this._lookaheadToken(0);this._advance();let r=this.nud(t),n=this._lookaheadToken(0,r);for(;e<ct[n.type];)this._advance(),r=this.led(n,r),n=this._lookaheadToken(0,r);return r}_lookahead(e){return this.tokens[this.index+e].type}_lookaheadToken(e,t={}){const r=this.tokens[this.index+e];return r.type===et&&([void 0,it,rt,De,qe,Ge,Ke,nt,Xe,Je,He,Qe,ot,je,Ve,We].includes(t.type)||(r.type=Xe)),r}_advance(){this.index+=1}_lookAheadIndex(){let e=0;return this._lookahead(e)===ze&&(e+=1),this._lookahead(e)===ut&&(e+=1),this._lookahead(e)===Be||this._lookahead(e)===we}_getIndex(){return this.index}_setIndex(e){this.index=e}nud(e){let t,r,n,s,i;switch(e.type){case at:return{type:"String",value:e.value};case Se:return{type:"Literal",value:e.value};case ke:return{type:"Number",value:e.value};case ut:return{type:"Integer",value:e.value};case xe:return{type:"Identifier",name:e.value};case Me:return s={type:"QuotedIdentifier",name:e.value},s;case nt:return r=this.expression(ct.Not),{type:"NotExpression",children:[r]};case ze:return r=this.expression(ct.UnaryMinus),{type:"UnaryMinusExpression",children:[r]};case et:return t={type:"Identity"},r=this._lookahead(0)===Be?{type:"Identity"}:this._parseProjectionRHS(ct.Star),{type:"ValueProjection",children:[t,r]};case tt:return this.led(e,{type:"Identity"});case st:return this._parseObjectExpression();case Ze:return t={type:Ze,children:[{type:"Identity"}]},r=this._parseProjectionRHS(ct.Flatten),{type:"Projection",children:[t,r]};case it:return this._lookAheadIndex()?(r=this._parseIndexExpression(),this._projectIfSlice({type:"Identity"},r)):this._lookahead(0)===et&&this._lookahead(1)===Be?(this._advance(),this._advance(),r=this._parseProjectionRHS(ct.Star),{type:"Projection",children:[{type:"Identity"},r],debug:"Wildcard"}):this._parseArrayExpression();case Fe:return{type:Fe};case Ce:return{type:Ce,name:e.name};case Le:return n=this.expression(ct.Expref),{type:"ExpressionReference",children:[n]};case ot:for(i=[];this._lookahead(0)!==Ue;)n=this.expression(0),i.push(n);return this._match(Ue),i[0];default:this._errorToken(e)}}led(e,t){let r,n,s,i,a,u,c,l;switch(e.type){case je:return n=this.expression(ct.Concatenate),{type:"ConcatenateExpression",children:[t,n]};case rt:return u=ct.Dot,this._lookahead(0)!==et?(n=this._parseDotRHS(u),{type:"ChainedExpression",children:[t,n]}):(this._advance(),n=this._parseProjectionRHS(u),{type:"ValueProjection",children:[t,n]});case De:return n=this.expression(ct.Pipe),{type:De,children:[t,n]};case Ge:return n=this.expression(ct.Or),{type:"OrExpression",children:[t,n]};case qe:return n=this.expression(ct.And),{type:"AndExpression",children:[t,n]};case Je:return n=this.expression(ct.Add),{type:"AddExpression",children:[t,n]};case He:return n=this.expression(ct.Subtract),{type:"SubtractExpression",children:[t,n]};case Xe:return n=this.expression(ct.Multiply),{type:"MultiplyExpression",children:[t,n]};case Qe:return n=this.expression(ct.Divide),{type:"DivideExpression",children:[t,n]};case Ve:return n=this.expression(ct.Union),{type:"UnionExpression",children:[t,n]};case ot:if(t.type!==xe)throw o("Bad function syntax. Parenthesis must be preceded by an unquoted identifier");return s=t.name,i=this._parseFunctionArgs(),a={type:"Function",name:s,children:i},a;case tt:return r=this.expression(0),this._match(Be),n=this._parseProjectionRHS(ct.Filter),{type:"FilterProjection",children:[t,n,r]};case Ze:return c={type:Ze,children:[t]},l=this._parseProjectionRHS(ct.Flatten),{type:"Projection",children:[c,l]};case We:return this._parseComparator(t,e);case it:return this._lookahead(0)===et&&this._lookahead(1)===Be?(this._advance(),this._advance(),n=this._parseProjectionRHS(ct.Star),{type:"Projection",children:[t,n],debug:"Wildcard"}):(n=this._parseIndexExpression(),this._projectIfSlice(t,n));default:this._errorToken(e)}}_match(e){const t=this._lookaheadToken(0);if(t.type===e)return this._advance(),t;throw o(`Expected ${e}, got: ${t.type}`)}_errorToken(e){throw o(`Unexpected token (${e.type}): "${e.value||e.name}"`)}_parseFunctionArgs(){let e=!0;const t=[];for(;this._lookahead(0)!==Ue;)e||this._match(Ke),t.push(this.expression(0)),e=!1;return this._match(Ue),t}_parseSignedInt(){const e=this._lookaheadToken(0);return e.type===ze?(this._advance(),{type:"SignedInt",value:-this._match(ut).value}):(e.type!==ut&&this._errorToken(e),this._advance(),{type:"SignedInt",value:e.value})}_parseIndexExpression(){const e=this._getIndex();if(this._lookahead(0)===we)return this._parseSliceExpression();const t=this._parseSignedInt();return this._lookahead(0)===we?(this._setIndex(e),this._parseSliceExpression()):(this._match(Be),{type:"Index",value:t})}_projectIfSlice(e,t){const r={type:"BracketExpression",children:[e,t]};return"Slice"===t.type?{type:"Projection",children:[r,this._parseProjectionRHS(ct.Star)]}:r}_parseSliceExpression(){const e=[null,null,null];let t=0,r=this._lookahead(0);for(;r!==Be&&t<3;){if(r===we&&t<2)t+=1,this._advance();else{e[t]=this._parseSignedInt();const r=this._lookahead(0);if(r!==we&&r!==Be)throw o(`Unexpected token: ${r.value}(${r.type})`)}r=this._lookahead(0)}return this._match(Be),{type:"Slice",children:e}}_parseComparator(e,t){const r=this.expression(ct[t.type]);return{type:"Comparator",value:t.value,children:[e,r]}}_parseDotRHS(e){const t=this._lookahead(0);if([xe,Me,et].indexOf(t)>=0)return this.expression(e);if(t===it)return this._match(it),this._parseArrayExpression();if(t===st)return this._match(st),this._parseObjectExpression();throw o('Expecting one of: "*", "[", "{", name or quoted name after a dot')}_parseProjectionRHS(e){let t;const r=this._lookaheadToken(0,{type:et});if(ct[r.type]<=ct[Ze])t={type:"Identity"};else if(r.type===it)t=this.expression(e);else if(r.type===tt)t=this.expression(e);else{if(r.type!==rt)throw o(`Unexpected token: ${r.value}(${r.type})`);this._match(rt),t=this._parseDotRHS(e)}return t}_parseArrayExpression(){const e=[];for(;this._lookahead(0)!==Be;){const t=this.expression(0);if(e.push(t),this._lookahead(0)===Ke&&(this._match(Ke),this._lookahead(0)===Be))throw o("Unexpected token Rbracket")}return this._match(Be),{type:"ArrayExpression",children:e}}_parseObjectExpression(){const e=[],t=[xe,Me];let r,n,s,i;if(this._lookahead(0)===$e)throw this.debug.push("To create an empty object, use a JSON literal: `{}`"),o("An empty object expression is not allowed");for(;;){if(r=this._lookaheadToken(0),t.indexOf(r.type)<0)throw o(`Expecting an identifier token, got: ${r.type}`);if(n=r.value,this._advance(),this._match(we),s=this.expression(0),i={type:"KeyValuePair",name:n,value:s},e.push(i),this._lookahead(0)===Ke)this._match(Ke);else if(this._lookahead(0)===$e){this._match($e);break}}return{type:"ObjectExpression",children:e}}}const ht=864e5;function _t(e){return new Date(Math.round(e*ht))}function pt(e){return e/ht}function dt(e,t){if(Number.isNaN(e)||!Number.isFinite(e))throw u(`Call to "${t}()" resulted in an invalid number`);return e}const{TYPE_OBJECT:ft}=r;function yt(e){if(null==e)return"";const t=N(e);if(O(t))throw i("Failed to convert array to string");if(t===ft)throw i("Failed to convert object to string");return e.toString()}const gt=e=>{const t=+e;return Number.isNaN(t)?0:t};class Et{constructor(e,t,s={}){this.strictDeepEqual=I,this.toNumber=t,this.functionTable=function(e,t,s,o,c,l,h,_){const{TYPE_NUMBER:p,TYPE_ANY:d,TYPE_STRING:f,TYPE_ARRAY:y,TYPE_OBJECT:g,TYPE_BOOLEAN:E,TYPE_EXPREF:T,TYPE_NULL:m,TYPE_ARRAY_NUMBER:v,TYPE_ARRAY_STRING:R,TYPE_ARRAY_ARRAY:N}=r;function O(e){let t=l(e);return o(t)===f&&(t=s(t)),t=Math.trunc(e),Number.isNaN(t)?e:t}function P(e,t){const r=l(e);if(o(r)===f)return e;const n=t?O(t):0;return JSON.stringify(r,null,n)}const b={abs:{_func:e=>Math.abs(e[0]),_signature:[{types:[p]}]},acos:{_func:e=>dt(Math.acos(e[0]),"acos"),_signature:[{types:[p]}]},and:{_func:e=>{let t=w(l(e[0]));return e.slice(1).forEach((e=>{t=t&&w(l(e))})),t},_signature:[{types:[r.TYPE_ANY],variadic:!0}]},asin:{_func:e=>dt(Math.asin(e[0]),"asin"),_signature:[{types:[p]}]},atan2:{_func:e=>Math.atan2(e[0],e[1]),_signature:[{types:[p]},{types:[p]}]},avg:{_func:e=>{let t=0;const r=e[0];if(0===r.length)throw u("avg() requires at least one argument");return r.forEach((e=>{t+=e})),t/r.length},_signature:[{types:[v]}]},casefold:{_func:(e,t,r)=>h(e[0]).toLocaleUpperCase(r.language).toLocaleLowerCase(r.language),_signature:[{types:[r.TYPE_STRING]}]},ceil:{_func:e=>Math.ceil(e[0]),_signature:[{types:[p]}]},codePoint:{_func:e=>{const t=h(e[0]);return 0===t.length?null:t.codePointAt(0)},_signature:[{types:[r.TYPE_STRING]}]},contains:{_func:e=>{const t=l(e[0]),r=l(e[1]);if(c(e[0]))return t.some((e=>I(e,r)));const n=Array.from(t);if(o(r)!==f)throw i("contains() requires a string search value for string subjects");if(""===r)return!0;const s=Array.from(r).length;for(let e=0;e<n.length;e+=1)if(n.slice(e,e+s).join("")===r)return!0;return!1},_signature:[{types:[f,y]},{types:[d]}]},cos:{_func:e=>Math.cos(e[0]),_signature:[{types:[p]}]},datedif:{_func:e=>{const t=h(e[2]).toLowerCase(),r=_t(e[0]),n=_t(e[1]);if(n===r)return 0;if(n<r)throw a("end_date must be >= start_date in datedif()");if("d"===t)return Math.floor(pt(n-r));const s=n.getFullYear()-r.getFullYear();let i=n.getMonth()-r.getMonth();const o=n.getDate()-r.getDate();if("y"===t){let e=s;return i<0&&(e-=1),0===i&&o<0&&(e-=1),e}if("m"===t)return 12*s+i+(o<0?-1:0);if("ym"===t)return o<0&&(i-=1),i<=0&&s>0?12+i:i;if("yd"===t)return o<0&&(i-=1),i<0?n.setFullYear(r.getFullYear()+1):n.setFullYear(r.getFullYear()),Math.floor(pt(n-r));throw a(`Unrecognized unit parameter "${t}" for datedif()`)},_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER]},{types:[r.TYPE_STRING]}]},datetime:{_func:e=>{const t=O(e[0]),r=O(e[1])-1,n=O(e[2]),s=e.length>3?O(e[3]):0,i=e.length>4?O(e[4]):0,o=e.length>5?O(e[5]):0,a=e.length>6?O(e[6]):0;return pt(new Date(t,r,n,s,i,o,a))},_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER],optional:!0},{types:[r.TYPE_NUMBER],optional:!0},{types:[r.TYPE_NUMBER],optional:!0},{types:[r.TYPE_NUMBER],optional:!0}]},day:{_func:e=>_t(e[0]).getDate(),_signature:[{types:[r.TYPE_NUMBER]}]},debug:{_func:t=>{const r=t[0];return t.length>1?o(t[1])===T?_.push(e.interpreter.visit(t[1],r)):_.push(t[1]):_.push(P(t[0])),r},_signature:[{types:[r.TYPE_ANY]},{types:[r.TYPE_ANY,r.TYPE_EXPREF],optional:!0}]},deepScan:{_func:e=>{const[r,n]=e,[s,i]=o(n)===p?[O(n),!0]:[h(n),!1],a=[];return function e(r){null!==r&&(c(r)?(i&&void 0!==r[s]&&a.push(r[s]),r.forEach(e)):t(r)&&Object.entries(r).forEach((([t,r])=>{i||t!==s||a.push(r),e(r)})))}(r),a},_signature:[{types:[r.TYPE_OBJECT,r.TYPE_ARRAY,r.TYPE_NULL]},{types:[r.TYPE_STRING,r.TYPE_NUMBER]}]},endsWith:{_func:e=>{const t=l(e[0]),r=l(e[1]),n=Array.from(t).reverse();return Array.from(r).reverse().every(((e,t)=>e===n[t]))},_signature:[{types:[f]},{types:[f]}]},entries:{_func:e=>{const t=l(e[0]);return Object.entries(t)},_signature:[{types:[r.TYPE_ARRAY,r.TYPE_OBJECT]}]},eomonth:{_func:e=>{const t=_t(e[0]),r=O(e[1]);return pt(new Date(t.getFullYear(),t.getMonth()+r+1,0))},_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER]}]},exp:{_func:e=>Math.exp(e[0]),_signature:[{types:[r.TYPE_NUMBER]}]},false:{_func:()=>!1,_signature:[]},find:{_func:e=>{const t=Array.from(h(e[0])),r=Array.from(h(e[1])),n=e.length>2?O(e[2]):0;if(n<0)throw u("find() start position must be >= 0");if(0===t.length)return n>r.length?null:n;for(let e=n;e<r.length;e+=1)if(r.slice(e,e+t.length).every(((e,r)=>e===t[r])))return e;return null},_signature:[{types:[r.TYPE_STRING]},{types:[r.TYPE_STRING]},{types:[r.TYPE_NUMBER],optional:!0}]},floor:{_func:e=>Math.floor(e[0]),_signature:[{types:[p]}]},fromCodePoint:{_func:e=>{const t=O(e[0]);try{return String.fromCodePoint(t)}catch(e){throw u(`Invalid code point: "${t}"`)}},_signature:[{types:[r.TYPE_NUMBER]}]},fromEntries:{_func:e=>{const t=e[0];if(!t.every((e=>2===e.length&&o(e[0])===f)))throw i("fromEntries() requires an array of key value pairs");return Object.fromEntries(t)},_signature:[{types:[r.TYPE_ARRAY_ARRAY]}]},fround:{_func:e=>Math.fround(e[0]),_signature:[{types:[p]}]},hasProperty:{_func:e=>{let t=e[1];const n=o(t);if(null!==e[0]&&Object.getOwnPropertyDescriptor(e[0],t)?.get)return!0;const s=l(e[0]);if(null===s)return!1;const a=c(s);if(!a&&o(s)!==r.TYPE_OBJECT)throw i("First parameter to hasProperty() must be either an object or array.");if(a){if(n!==p)throw TypeError("hasProperty(): Array index must be an integer");t=O(t)}else if(n!==f)throw TypeError("hasProperty(): Object key must be a string");return void 0!==x(s,t)},_signature:[{types:[r.TYPE_ANY]},{types:[r.TYPE_STRING,r.TYPE_NUMBER]}]},hour:{_func:e=>_t(e[0]).getHours(),_signature:[{types:[r.TYPE_NUMBER]}]},if:{_func:(e,t,r)=>{const n=e[0],s=e[1],o=e[2];e.forEach((e=>{if("ExpressionReference"===e.type)throw i('"if()" does not accept an expression reference argument.')}));const a=r.visit(n,t);return w(l(a))?r.visit(s,t):r.visit(o,t)},_signature:[{types:[r.TYPE_ANY]},{types:[r.TYPE_ANY]},{types:[r.TYPE_ANY]}]},join:{_func:e=>{const t=e[0],r=e[1];return t.map((e=>P(e))).join(r)},_signature:[{types:[y]},{types:[f]}]},keys:{_func:e=>Object.keys(e[0]),_signature:[{types:[g]}]},left:{_func:e=>{const t=e.length>1?O(e[1]):1;if(t<0)throw u("left() requires a non-negative number of elements");return c(e[0])?e[0].slice(0,t):Array.from(h(e[0])).slice(0,t).join("")},_signature:[{types:[r.TYPE_STRING,r.TYPE_ARRAY]},{types:[r.TYPE_NUMBER],optional:!0}]},length:{_func:e=>{const r=l(e[0]);return t(r)?Object.keys(r).length:c(r)?r.length:Array.from(h(r)).length},_signature:[{types:[f,y,g]}]},log:{_func:e=>dt(Math.log(e[0]),"log"),_signature:[{types:[p]}]},log10:{_func:e=>dt(Math.log10(e[0]),"log10"),_signature:[{types:[p]}]},lower:{_func:e=>h(e[0]).toLowerCase(),_signature:[{types:[r.TYPE_STRING]}]},map:{_func:t=>{const r=t[1];return t[0].map((t=>e.interpreter.visit(r,t)))},_signature:[{types:[y]},{types:[T]}]},max:{_func:e=>{const t=e.reduce(((e,t)=>e.concat(t)),[]);if(0===t.length)throw u("max() requires at least one argument");if(!t.every((e=>o(e)===p))&&!t.every((e=>o(e)===f)))throw i("max() requires all arguments to be of the same type");return t.sort(((e,t)=>e>t?1:-1)).pop()},_signature:[{types:[v,R,p,f],variadic:!0}]},merge:{_func:e=>{const t={};return e.forEach((e=>{null!==e&&Object.entries(e||{}).forEach((([e,r])=>{t[e]=r}))})),t},_signature:[{types:[g,m],variadic:!0}]},mid:{_func:e=>{const t=O(e[1]),r=O(e[2]);if(t<0)throw u("mid() requires a non-negative start position");if(r<0)throw u("mid() requires a non-negative length parameter");return c(e[0])?e[0].slice(t,t+r):Array.from(h(e[0])).slice(t,t+r).join("")},_signature:[{types:[r.TYPE_STRING,r.TYPE_ARRAY]},{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER]}]},millisecond:{_func:e=>_t(e[0]).getMilliseconds(),_signature:[{types:[r.TYPE_NUMBER]}]},min:{_func:e=>{const t=e.reduce(((e,t)=>e.concat(t)),[]);if(0===t.length)throw u("min() requires at least one argument");if(!t.every((e=>o(e)===p))&&!t.every((e=>o(e)===f)))throw i("max() requires all arguments to be of the same type");return t.sort(((e,t)=>e<t?1:-1)).pop()},_signature:[{types:[v,R,p,f],variadic:!0}]},minute:{_func:e=>_t(e[0]).getMinutes(),_signature:[{types:[r.TYPE_NUMBER]}]},mod:{_func:e=>{const t=e[0],r=e[1],n=t%r;if(Number.isNaN(n))throw u(`Bad parameter for mod: '${t} % ${r}'`);return n},_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER]}]},month:{_func:e=>_t(e[0]).getMonth()+1,_signature:[{types:[r.TYPE_NUMBER]}]},not:{_func:e=>!w(l(e[0])),_signature:[{types:[r.TYPE_ANY]}]},notNull:{_func:e=>{const t=e.find((e=>o(e)!==m));return void 0===t?null:t},_signature:[{types:[d],variadic:!0}]},now:{_func:()=>pt(Date.now()),_signature:[]},null:{_func:()=>null,_signature:[]},or:{_func:e=>{let t=w(l(e[0]));return e.slice(1).forEach((e=>{t=t||w(l(e))})),t},_signature:[{types:[r.TYPE_ANY],variadic:!0}]},power:{_func:e=>dt(e[0]**e[1],"power"),_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER]}]},proper:{_func:e=>{const t=e=>`${e.charAt(0).toUpperCase()}${e.slice(1).toLowerCase()}`,r=h(e[0]),n=r.match(/[\s\d\p{P}]+|[^\s\d\p{P}]+/gu);return null!==n?n.map((e=>t(e))).join(""):t(r)},_signature:[{types:[r.TYPE_STRING]}]},random:{_func:()=>Math.random(),_signature:[]},reduce:{_func:t=>{const r=t[1];return t[0].reduce(((t,n,s,i)=>e.interpreter.visit(r,{accumulated:t,current:n,index:s,array:i})),3===t.length?t[2]:null)},_signature:[{types:[y]},{types:[T]},{types:[d],optional:!0}]},register:{_func:t=>{const r=t[0],n=t[1];if(!/^_[_a-zA-Z0-9$]*$/.test(r))throw a(`Invalid function name: "${r}"`);if(b[r]&&b[r]._exprefNode.value!==n.value)throw a(`Cannot override function: "${r}" with a different definition`);return b[r]={_func:t=>e.interpreter.visit(n,...t),_signature:[{types:[d],optional:!0}],_exprefNode:n},{}},_signature:[{types:[f]},{types:[T]}]},replace:{_func:e=>{const t=O(e[1]),r=O(e[2]);if(t<0)throw u("replace() start position must be greater than or equal to 0");if(r<0)throw u("replace() length must be greater than or equal to 0");if(c(e[0])){const n=l(e[0]);let s=l(e[3]);return c(s)||(s=[s]),n.splice(t,r,...s),n}const n=Array.from(h(e[0]));if(c(e[3])||o(e[3])===g)throw i("replace() replacement must not be an array or object");const s=h(e[3]);return n.splice(t,r,s),n.join("")},_signature:[{types:[r.TYPE_STRING,r.TYPE_ARRAY]},{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER]},{types:[r.TYPE_ANY]}]},rept:{_func:e=>{const t=h(e[0]),r=O(e[1]);if(r<0)throw u("rept() count must be greater than or equal to 0");return t.repeat(r)},_signature:[{types:[r.TYPE_STRING]},{types:[r.TYPE_NUMBER]}]},reverse:{_func:e=>{const t=l(e[0]);return o(t)===f?Array.from(t).reverse().join(""):e[0].slice(0).reverse()},_signature:[{types:[f,y]}]},right:{_func:e=>{const t=e.length>1?O(e[1]):1;if(t<0)throw u("right() count must be greater than or equal to 0");return e[0]instanceof Array?0===t?[]:e[0].slice(-1*t):0===t?"":Array.from(h(e[0])).slice(-1*t).join("")},_signature:[{types:[r.TYPE_STRING,r.TYPE_ARRAY]},{types:[r.TYPE_NUMBER],optional:!0}]},round:{_func:e=>function(e,t){const r=10**t;return Math.round(e*r)/r}(e[0],e.length>1?O(e[1]):0),_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER],optional:!0}]},search:{_func:e=>{const t=h(e[0]),r=h(e[1]),n=e.length>2?O(e[2]):0;if(n<0)throw a("search() startPos must be greater than or equal to 0");if(null===t||null===r||0===r.length)return[];const s=Array.from(t).reduce(((e,t)=>e.escape?{escape:!1,result:e.result.concat(t)}:"\\"===t?{escape:!0,result:e.result}:"?"===t?{escape:!1,result:e.result.concat("dot")}:"*"===t?"star"===e.result.slice(-1).pop()?e:{escape:!1,result:e.result.concat("star")}:{escape:!1,result:e.result.concat(t)}),{escape:!1,result:[]}).result,i=(e,t,r)=>{if(0===t.length)return r;if(0===e.length)return null;const n=e[0];let[s,...o]=t;const a="star"===s;if(a){if(1===t.length)return r;[s,...o]=t.slice(1)}return n===s||"dot"===s?i(e.slice(1),o,r.concat(n)):a?i(e.slice(1),t,r.concat(n)):null},o=Array.from(r);for(let e=n;e<o.length;e+=1){const t=i(o.slice(e),s,[]);if(null!==t)return[e,t.join("")]}return[]},_signature:[{types:[r.TYPE_STRING]},{types:[r.TYPE_STRING]},{types:[r.TYPE_NUMBER],optional:!0}]},second:{_func:e=>_t(e[0]).getSeconds(),_signature:[{types:[r.TYPE_NUMBER]}]},sign:{_func:e=>Math.sign(e[0]),_signature:[{types:[p]}]},sin:{_func:e=>Math.sin(e[0]),_signature:[{types:[p]}]},sort:{_func:e=>{const t=e[0].slice();return 0===t.length?[]:o(t[0])===f?t.sort():t.sort(((e,t)=>e<t?-1:e>t?1:0))},_signature:[{types:[R,v]}]},sortBy:{_func:t=>{const r=t[0].slice(0);if(0===r.length)return r;const s=t[1],a=o(e.interpreter.visit(s,r[0]));if(![p,f].includes(a))throw i("Bad data type for sortBy()");const u=[];for(let e=0;e<r.length;e+=1)u.push([e,r[e]]);u.sort(((t,r)=>{const u=e.interpreter.visit(s,t[1]),c=o(u),l=e.interpreter.visit(s,r[1]),h=o(l);if(c!==a)throw i(`sortBy expected ${n[a]}, received ${n[c]}`);if(h!==a)throw i(`sortyBy expected ${n[a]}, received ${n[h]}`);return u>l?1:u<l?-1:t[0]-r[0]}));for(let e=0;e<u.length;e+=1)[,r[e]]=u[e];return r},_signature:[{types:[y]},{types:[T]}]},split:{_func:e=>{const t=h(e[0]),r=h(e[1]);return 0===r.length?Array.from(t):t.split(r)},_signature:[{types:[r.TYPE_STRING]},{types:[r.TYPE_STRING]}]},sqrt:{_func:e=>dt(Math.sqrt(e[0]),"sqrt"),_signature:[{types:[r.TYPE_NUMBER]}]},startsWith:{_func:e=>{const t=Array.from(h(e[0])),r=Array.from(h(e[1]));if(r.length>t.length)return!1;for(let e=0;e<r.length;e+=1)if(r[e]!==t[e])return!1;return!0},_signature:[{types:[f]},{types:[f]}]},stdev:{_func:e=>{const t=e[0];if(t.length<=1)throw u("stdev() must have at least two values");const r=t.reduce(((e,t)=>e+t),0)/t.length,n=t.reduce(((e,t)=>e+t*t),0);return dt(Math.sqrt((n-t.length*r*r)/(t.length-1)),"stdev")},_signature:[{types:[r.TYPE_ARRAY_NUMBER]}]},stdevp:{_func:e=>{const t=e[0];if(0===t.length)throw u("stdevp() must have at least one value");const r=t.reduce(((e,t)=>e+t),0)/t.length,n=t.reduce(((e,t)=>e+t*t),0)/t.length;return dt(Math.sqrt(n-r*r),"stdevp")},_signature:[{types:[r.TYPE_ARRAY_NUMBER]}]},substitute:{_func:e=>{const t=Array.from(h(e[0])),r=Array.from(h(e[1])),n=Array.from(h(e[2]));if(0===r.length)return e[0];let s=!0,i=0;if(e.length>3){if(s=!1,i=O(e[3]),i<0)throw u("substitute() which parameter must be greater than or equal to 0");i+=1}let o=0;const a=[];for(let e=0;e<t.length;){const u=r.every(((r,n)=>t[e+n]===r));u&&(o+=1),u&&(s||o===i)?(a.push(...n),e+=r.length):(a.push(t[e]),e+=1)}return a.join("")},_signature:[{types:[r.TYPE_STRING]},{types:[r.TYPE_STRING]},{types:[r.TYPE_STRING]},{types:[r.TYPE_NUMBER],optional:!0}]},sum:{_func:e=>{let t=0;return e[0].forEach((e=>{t+=1*e})),t},_signature:[{types:[v]}]},tan:{_func:e=>Math.tan(e[0]),_signature:[{types:[p]}]},time:{_func:e=>{const t=O(e[0]),r=e.length>1?O(e[1]):0,n=e.length>2?O(e[2]):0;return pt(new Date(1970,0,1,t,r,n))},_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER],optional:!0},{types:[r.TYPE_NUMBER],optional:!0}]},toArray:{_func:e=>c(e[0])?e[0]:[e[0]],_signature:[{types:[d]}]},toDate:{_func:e=>{const t=h(e[0]).replace(/(\d\d\d\d)(\d\d)(\d\d)/,"$1-$2-$3").replace(/T(\d\d)(\d\d)(\d\d)/,"T$1:$2:$3"),r=t.split(/[\D,zZ]+/);let n;if(r.length<=3&&(r.length<3||""===r.find((e=>""===e))))return _.push(`Failed to convert "${e[0]}" to a date`),null;if(r.length<7){const t=[99999,12,31,23,59,59,999];for(let n=0;n<r.length;n+=1)if(r[n]>t[n])return _.push(`Failed to convert "${e[0]}" to a date`),null;n=new Date(...r.map(((e,t)=>1===t?e-1:1*e)))}else n=new Date(t);return n instanceof Date&&Number.isFinite(n.getTime())?pt(n):(_.push(`Failed to convert "${e[0]}" to a date`),null)},_signature:[{types:[f]}]},today:{_func:()=>{const e=new Date(Date.now());return pt(new Date(e.getFullYear(),e.getMonth(),e.getDate()))},_signature:[]},toNumber:{_func:e=>{const t=l(e[0]),r=e.length>1?O(e[1]):10;if(o(t)===f&&10!==r){let e;if(2===r)e=/^[01.]+$/;else if(8===r)e=/^[0-7.]+$/;else{if(16!==r)throw u(`Invalid base: "${r}" for toNumber()`);e=/^[0-9A-Fa-f.]+$/}if(""===t)return 0;if(!e.test(t))return _.push(`Failed to convert "${t}" base "${r}" to number`),null;const n=t.split(".");let s=0;n.length>1&&(s=parseInt(n[1],r)*r**-n[1].length);const i=parseInt(n[0],r)+s;return n.length>2||Number.isNaN(i)?(_.push(`Failed to convert "${t}" base "${r}" to number`),null):i}try{return s(t)}catch(e){return _.push(`Failed to convert "${t}" to number`),null}},_signature:[{types:[d]},{types:[r.TYPE_NUMBER],optional:!0}]},toString:{_func:e=>P(e[0],e.length>1?e[1]:0),_signature:[{types:[d]},{types:[p],optional:!0}]},trim:{_func:e=>h(e[0]).split(" ").filter((e=>e)).join(" "),_signature:[{types:[r.TYPE_STRING]}]},true:{_func:()=>!0,_signature:[]},trunc:{_func:e=>{const t=e[0],r=e.length>1?O(e[1]):0;return(t>=0?Math.floor:Math.ceil)(t*10**r)/10**r},_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER],optional:!0}]},type:{_func:e=>({[p]:"number",[f]:"string",[y]:"array",[v]:"array",[R]:"array",[N]:"array",[g]:"object",[E]:"boolean",[T]:"expref",[m]:"null"}[o(e[0])]),_signature:[{types:[d]}]},unique:{_func:e=>{const t=e[0].map((e=>l(e)));return e[0].filter(((e,r)=>t.findIndex((t=>I(t,l(e))))===r))},_signature:[{types:[r.TYPE_ARRAY]}]},upper:{_func:e=>h(e[0]).toUpperCase(),_signature:[{types:[r.TYPE_STRING]}]},value:{_func:e=>{const t=o(e[1]);let n=e[1];const s=c(e[0]);if(null!==e[0]&&Object.getOwnPropertyDescriptor(e[0],n)?.get)return x(e[0],n);const a=l(e[0]);if(null===a)return null;if(o(a)!==r.TYPE_OBJECT&&!s)throw i("First parameter to value() must be one of: object, array, null.");if(s){if(t!==p)throw i("value() requires an integer index for arrays");n=O(n)}else if(t!==f)throw i("value() requires a string index for objects");const u=x(e[0],n);return void 0===u?(s?_.push(`Index: ${n} out of range for array size: ${a.length}`):M(_,a,n),null):u},_signature:[{types:[r.TYPE_ANY]},{types:[r.TYPE_STRING,r.TYPE_NUMBER]}]},values:{_func:e=>Object.values(e[0]),_signature:[{types:[g]}]},weekday:{_func:e=>{const t=e[0],r=e.length>1?O(e[1]):1,n=_t(t).getDay();switch(r){case 1:return n+1;case 2:return(n+6)%7+1;case 3:return(n+6)%7;default:throw a(`Unsupported returnType: "${r}" for weekday()`)}},_signature:[{types:[r.TYPE_NUMBER]},{types:[r.TYPE_NUMBER],optional:!0}]},year:{_func:e=>_t(e[0]).getFullYear(),_signature:[{types:[r.TYPE_NUMBER]}]},zip:{_func:e=>{const t=e.reduce(((e,t)=>Math.min(e,t.length)),e[0].length),r=new Array(t);for(let n=0;n<t;n+=1)r[n]=[],e.forEach((e=>{r[n].push(e[n])}));return r},_signature:[{types:[y],variadic:!0}]}};return b}(this,A,t,N,O,S,yt,e),Object.entries(s).forEach((([e,t])=>{t._runtime=this,this.functionTable[e]=t}))}_validateArgs(e,t,r,n){if(0===r.length&&t.length>0)throw a(`${e}() does not accept parameters`);if(0===r.length)return;let s;const i=r.filter((e=>!e.optional)).length;if(r[r.length-1].variadic){if(t.length<r.length)throw s=1===r.length?" argument":" arguments",a(`${e}() takes at least ${r.length}${s} but received ${t.length}`)}else if(t.length<i||t.length>r.length)throw s=1===r.length?" argument":" arguments",a(`${e}() takes ${r.length}${s} but received ${t.length}`);if(!n)return;let o;const u=r[r.length-1].variadic?t.length:Math.min(r.length,t.length);for(let n=0;n<u;n+=1)o=n>r.length-1?r[r.length-1].types:r[n].types,t[n]=b(o,t[n],e,this.toNumber,yt)}callFunction(e,t,r,n,s=!0){if(!Object.prototype.hasOwnProperty.call(this.functionTable,e))throw a(`No such function: ${e}()`);const i=this.functionTable[e];return this._validateArgs(e,t,i._signature,s),i._func.call(this,t,r,n)}}class Tt{constructor(e,t,r){this.debug=e,this.toNumber=function(e){return t=>{const r=S(t);if(null===r)return 0;if(r instanceof Array)throw i("Failed to convert array to number");const n=typeof r;if("number"===n)return r;if("string"===n)return e(r);if("boolean"===n)return r?1:0;throw i("Failed to convert object to number")}}(r||gt),this.runtime=new Et(e,this.toNumber,t)}compile(e,t=[]){return new lt(t).parse(e,this.debug)}search(e,t,r={},n="en-US"){this.runtime.interpreter=new G(this.runtime,r,this.toNumber,yt,this.debug,n);try{return this.runtime.interpreter.search(e,t)}catch(e){if(this.debug.push(e.message||e.toString()),"Error"===e.name)throw u(e.message||e.toString());throw e}}}const mt=class{constructor(e={},t=null,r=[]){this.customFunctions={...e},this.stringToNumber=t,this.debug=r,this.formula=new Tt(r,e,t)}search(e,t,r={},n="en-US"){const s=this.compile(e,Object.keys(r));return this.run(s,t,n,r)}run(e,t,r,n){return this.formula.search(e,t,n,r)}compile(e,t=[]){return this.debug.length=0,this.formula.compile(e,t)}};class vt extends Array{}class Rt{}function Nt(e,t,r,n){const s=t?new class extends Rt{_add(e,t){this[e]=t,n.push(t)}}:new class extends vt{_add(e,t){this[e]=t,n.push(t)}};return Object.defineProperty(s,"$name",{get:()=>e}),Object.defineProperty(s,"$fields",{get:()=>r}),Object.defineProperty(s,"$value",{get:()=>s.valueOf()}),s}function Ot(e,t,r){const n=[];if(r instanceof Array)e._add(t,Nt(t,!1,n,[])),r.forEach(((r,s)=>{const i=Ot(e[t],s,r);n.push(...i)}));else if(null!==r&&"object"==typeof r)e._add(t,Nt(t,!0,n,[])),Object.keys(r).forEach((s=>{const i=Ot(e[t],s,r[s]);n.push(...i)}));else{const s=function(e,t,r=!1,n=!0){const s=new class extends Rt{valueOf(){return t}toString(){return t.toString()}toJSON(){return t}};return Object.defineProperty(s,"$name",{get:()=>e}),Object.defineProperty(s,"$value",{get:()=>t}),Object.defineProperty(s,"$readonly",{get:()=>r}),Object.defineProperty(s,"$required",{get:()=>n}),s}(t,r);e._add(t,s),n.push(s)}return n}function Pt(e){const t=+e;if(Number.isNaN(t))throw i(`Failed to convert "${e}" to number`);return t}window.addEventListener("load",(()=>{const e=document.getElementById("data"),t=document.getElementById("expression"),r=document.getElementById("result"),n=document.getElementById("debug"),s=[],i=new mt({},Pt,s),o='{\n    "address": {\n      "street": "12 Oak St",\n      "city": "San Jose",\n      "state": "CA",\n      "country": "USA",\n      "phone": "1234561234"\n    },\n    "items": [\n      {\n        "desc": "pens",\n        "quantity": 2,\n        "price": 3.23\n      },\n      {\n        "desc": "pencils",\n        "quantity": 3,\n        "price": 1.34\n      }\n    ],\n    "tax": 1.13\n  }',a=new URLSearchParams(document.location.search);if(a.has("sample")){const r=JSON.parse(atob(a.get("sample")));r.data&&(e.value=JSON.stringify(r.data,null,2)),r.expression&&(t.value=r.expression),r.description&&(document.getElementById("description-row").style.display="table-row",document.getElementById("description").innerText=r.description),Array.from(document.getElementsByClassName("controls")).forEach((e=>e.classList.add("hidden")))}else{const r=window.localStorage.getItem("data");e.value=r||o;const n=window.localStorage.getItem("expression");t.value=n||"sum(items[*].price * items[*].quantity)"}function u(){window.localStorage.setItem("data",e.value),window.localStorage.setItem("expression",t.value);const o=t.value,a=document.getElementById("use-fields").checked;let u;try{u=JSON.parse(e.value),a&&(u=function(e){if(null===e||"object"!=typeof e)return e;const t=[],r=Nt("",!Array.isArray(e),t,[]);return Object.entries(e).forEach((([e,n])=>{t.push(...Ot(r,e,n))})),r}(u))}catch(e){return void(r.value=e.toString())}try{const e=i.search(o,u,{});n.innerHTML=s.join("\n");let t=e;null!=e&&(t=e.valueOf.call(e)),r.value="object"==typeof t?JSON.stringify(t,null,2):t}catch(e){r.value=e.toString(),n.innerHTML=s.join("\n")}}e.addEventListener("blur",u),t.addEventListener("blur",u),document.getElementById("data-reset").addEventListener("click",(()=>{e.value=o,a.has("sample")&&(t.value="sum(items[*].price * items[*].quantity)",document.getElementById("description-row").style.display="none",Array.from(document.getElementsByClassName("controls")).forEach((e=>e.classList.remove("hidden"))),window.history.pushState({},document.title,"/"),u())})),document.getElementById("canned").addEventListener("change",(e=>{t.value=e.target.value,u()})),u(),fetch("../antlr/JsonFormula.g4").then((e=>{e.text().then((e=>{const t=e.replace(/[\s\S.]*grammar/m,"grammar").replace(/#.*/g,"");document.getElementById("grammar-out").innerHTML=t}))}))}))})(),jsonFormula=t})();
//# sourceMappingURL=tutorial.js.map